<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Convert Go to Flutter and Dart for PineTime Companion App</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Convert Go to Flutter and Dart for PineTime Companion App" 
    data-rh="true">
<meta property="og:description" 
    content="How we build the Flutter Companion App (Android and iOS) for PineTime Smart Watch by converting Go to Dart" 
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/companion-title.png">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Convert Go to Flutter and Dart for PineTime Companion App</h1>
    <nav id="TOC"><ul>
<li><a href="#go-vs-dart-coding">1 Go vs Dart Coding</a><ul></ul></li>
<li><a href="#convert-go-structs-methods-and-interfaces-to-dart">2 Convert Go Structs, Methods and Interfaces to Dart</a><ul>
<li><a href="#go-structs-become-dart-classes">2.1 Go Structs Become Dart Classes</a><ul></ul></li>
<li><a href="#move-methods-inside-classes">2.2 Move Methods Inside Classes</a><ul></ul></li>
<li><a href="#add-dart-constructors">2.3 Add Dart Constructors</a><ul></ul></li>
<li><a href="#go-interfaces-become-dart-abstract-classes">2.4 Go Interfaces Become Dart Abstract Classes</a><ul></ul></li></ul></li>
<li><a href="#but-some-go-structs-become-dart-mixins">3 But Some Go Structs Become Dart Mixins</a><ul></ul></li>
<li><a href="#convert-go-arrays-to-dart">4 Convert Go Arrays to Dart</a><ul></ul></li>
<li><a href="#dive-deep-into-go-and-newt-manager">5 Dive Deep into Go and Newt Manager</a><ul></ul></li>
<li><a href="#cbor-encoding-in-dart">6 CBOR Encoding in Dart</a><ul></ul></li>
<li><a href="#test-dart-code-on-command-line">7 Test Dart Code on Command Line</a><ul></ul></li>
<li><a href="#add-dart-code-to-flutter-app">8 Add Dart Code to Flutter App</a><ul></ul></li>
<li><a href="#run-our-flutter-app">9 Run Our Flutter App</a><ul></ul></li>
<li><a href="#whats-next">10 What's Next</a><ul></ul></li>
<li><a href="#further-reading">11 Further Reading</a><ul></ul></li></ul></nav><p><img src="https://lupyuen.github.io/images/companion-title.png" alt="Convert Go to Flutter and Dart for PineTime Companion App" /></p>
<p>Can we take a <strong>single code base</strong>... And turn it into a mobile app for <strong>Android, iOS and Linux phones</strong> (like PinePhone)?</p>
<p>And code it in a <strong>modern programming language</strong> with <strong>Garbage Collection</strong>... Without the scary C pointers?</p>
<p>And talk <strong>Bluetooth Low Energy</strong> to other gadgets... Like <a href="https://wiki.pine64.org/index.php/PineTime"><strong>PineTime Smart Watch</strong></a>?</p>
<p><strong>Yes we can!</strong> Based on the quick experiment described in this article.</p>
<p>Read on to learn how we are building the <a href="https://github.com/lupyuen/pinetime-companion">Flutter Companion App</a> for PineTime Smart Watch... By converting the Go code (on Linux) to Flutter + Dart (on Android and iOS), line by line. (It's actually not that hard!)</p>
<p>The code is not 100% identical, but it will save the PineTime FOSS Community a lot of effort in maintaining the Android, iOS and Linux versions of the PineTime Companion App.</p>
<p>I'll explain how this Linux Command Line App in Go...</p>
<p><img src="https://lupyuen.github.io/images/companion-newtmgr.png" alt="Newt Manager showing response from PineTime Smart Watch" /></p>
<p><em>(Which will eventually be dressed up with <a href="https://github.com/gotk3/gotk3"><code>gotk3</code></a>, the GTK3 library for Go)</em></p>
<p>...Was converted line by line to this Flutter app for Android and iOS...</p>
<p><img src="https://lupyuen.github.io/images/companion-response.png" alt="Flutter Companion App showing response from PineTime Smart Watch" /></p>
<p><em>(The highlighted part shows the identical responses returned by PineTime to both apps over Bluetooth LE. So it really works!)</em></p>
<p>Here'a the video demo...</p>
<ul>
<li>
<p><a href="https://youtu.be/n396JA62NDk">Watch on YouTube</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/releases/download/v4.2.3/companion-query-firmware.mov">Download the video</a></p>
</li>
</ul>
<h1 id="go-vs-dart-coding" class="section-header"><a href="#go-vs-dart-coding">1 Go vs Dart Coding</a></h1>
<p>Let's learn to convert this chunk of Go code from <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/nmxact/nmp/nmp.go#L36-L45"><code>nmxact/nmp/nmp.go</code></a>...</p>
<pre><code class="language-go">//  In Go...
const NMP_HDR_SIZE = 8

/// SMP Header
type NmpHdr struct {
  Op    uint8  //  3 bits of opcode
  Flags uint8
  Len   uint16
  Group uint16
  Seq   uint8
  Id    uint8
}

/// Return this SMP Header as a list of bytes
func (hdr *NmpHdr) Bytes() []byte {
  buf := make([]byte, 0, NMP_HDR_SIZE)

  buf = append(buf, byte(hdr.Op))
  buf = append(buf, byte(hdr.Flags))

  u16b := make([]byte, 2)
  binary.BigEndian.PutUint16(u16b, hdr.Len)
  buf = append(buf, u16b...)

  binary.BigEndian.PutUint16(u16b, hdr.Group)
  buf = append(buf, u16b...)

  buf = append(buf, byte(hdr.Seq))
  buf = append(buf, byte(hdr.Id))

  return buf
}
</code></pre>
<p>...To Dart: <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/newtmgr.dart#L27-L67"><code>newtmgr.dart</code></a></p>
<pre><code class="language-dart">//  In Dart...
const NMP_HDR_SIZE = 8;

/// SMP Header
class NmpHdr {
  int Op;    //  Previously uint8
  int Flags; //  Previously uint8
  int Len;   //  Previously uint16
  int Group; //  Previously uint16
  int Seq;   //  Previously uint8
  int Id;    //  Previously uint8
  
  /// Construct an SMP Header
  NmpHdr(
    this.Op,
    this.Flags,
    this.Len,
    this.Group,
    this.Seq,
    this.Id
  );
  
  /// Return this SMP Header as a list of bytes
  typed.Uint8Buffer Bytes() {  //  Previously returns []byte
    var buf = typed.Uint8Buffer();
    
    buf.add(this.Op);
    buf.add(this.Flags);

    typed.Uint8Buffer u16b = binaryBigEndianPutUint16(this.Len);
    buf.addAll(u16b);

    u16b = binaryBigEndianPutUint16(this.Group);
    buf.addAll(u16b);

    buf.add(this.Seq);
    buf.add(this.Id);
    assert(buf.length == NMP_HDR_SIZE);

    return buf;
  }  
}
</code></pre>
<p><em>How shall we begin the code conversion from Go to Dart?</em></p>
<ol>
<li>
<p><strong>Add the trailing semicolons (<code>;</code>)</strong></p>
<p>Semicolons are optional in Go, but mandatory in Dart. So every line in Dart needs to terminate with a semicolon. Hence this code in Go...</p>
<pre><code class="language-go">//  In Go...
const NMP_HDR_SIZE = 8
</code></pre>
<p>Becomes this code in Dart...</p>
<pre><code class="language-dart">//  In Dart...
const NMP_HDR_SIZE = 8;
</code></pre>
</li>
<li>
<p><strong>Flip the names and types of variables</strong></p>
<p>Go puts the variable name before the type name... Dart does it the other way around. Hence this code in Go...</p>
<pre><code class="language-go">//  In Go...
Op uint8
</code></pre>
<p>Becomes this code in Dart...</p>
<pre><code class="language-dart">//  In Dart...
int Op;
</code></pre>
</li>
<li>
<p>Dart doesn't have specific numeric types like <code>uint8</code> (unsigned 8-bit integer). So we use <code>int</code> to represent a byte.</p>
<p>We write assertions in Dart to make sure that the <code>int</code> values are indeed bytes...</p>
<pre><code class="language-dart">//  In Dart...
assert(val &gt;= 0 &amp;&amp; val &lt;= 255);  //  val must be a byte
</code></pre>
</li>
<li>
<p>We rewrite Go byte arrays <code>[]byte</code> as the Dart type <code>typed.Uint8Buffer</code> (from the helper library <a href="https://pub.dev/packages/typed_data"><code>typed_data</code></a>)...</p>
<pre><code class="language-go">//  In Go...
//  Bytes() is a function that returns a byte array
func (hdr *NmpHdr) Bytes() []byte {
</code></pre>
<p>Becomes this...</p>
<pre><code class="language-dart">//  In Dart...
//  Import the helper library for Byte Buffers: https://pub.dev/packages/typed_data
import 'package:typed_data/typed_data.dart' as typed;

//  Bytes() is a function that returns a byte array
typed.Uint8Buffer Bytes() {
</code></pre>
</li>
</ol>
<p>Read on for more conversion steps.</p>
<h1 id="convert-go-structs-methods-and-interfaces-to-dart" class="section-header"><a href="#convert-go-structs-methods-and-interfaces-to-dart">2 Convert Go Structs, Methods and Interfaces to Dart</a></h1>
<p>These language overview docs are very helpful when converting Go to Dart...</p>
<ol>
<li>
<p><a href="https://benhoyt.com/writings/go-intro/"><em>&quot;An intro to Go for non-Go developers&quot;</em></a></p>
</li>
<li>
<p><a href="https://dart.dev/guides/language/language-tour"><em>&quot;A tour of the Dart language&quot;</em></a></p>
</li>
</ol>
<p>I'm new to Dart and it looks like a mix of Java and JavaScript. But like Go (and unlike JavaScript), Dart is Static Typed with Type Inference, which simplifies the code conversion.</p>
<h2 id="go-structs-become-dart-classes" class="section-header"><a href="#go-structs-become-dart-classes">2.1 Go Structs Become Dart Classes</a></h2>
<p>We rewrite a Go <code>struct</code> as a Dart <code>class</code>...</p>
<pre><code class="language-go">//  In Go...
type NmpHdr struct {
  Op uint8
  ...
}
</code></pre>
<p>Becomes this...</p>
<pre><code class="language-dart">//  In Dart...
class NmpHdr {
  int Op;
  ...
}
</code></pre>
<h2 id="move-methods-inside-classes" class="section-header"><a href="#move-methods-inside-classes">2.2 Move Methods Inside Classes</a></h2>
<p>We move Go methods inside Dart classes...</p>
<pre><code class="language-go">//  In Go...
type NmpHdr struct {
  Op uint8
  ...
}

//  Bytes() method for NmpHdr
func (hdr *NmpHdr) Bytes() []byte { ...
</code></pre>
<p>Becomes this...</p>
<pre><code class="language-dart">//  In Dart...
class NmpHdr {
  int Op;
  ...
  //  Bytes() method for NmpHdr
  typed.Uint8Buffer Bytes() { ...
}
</code></pre>
<h2 id="add-dart-constructors" class="section-header"><a href="#add-dart-constructors">2.3 Add Dart Constructors</a></h2>
<p>Go has implicit constructors for <code>structs</code>. We'll have to add Dart constructors like this...</p>
<pre><code class="language-dart">//  In Dart...
class NmpHdr {
  int Op;

  //  Constructor for NmpHdr
  NmpHdr(
    this.Op
  );
}
</code></pre>
<p><code>NmpHdr</code> is the common Message Header that we'll be transmit to PineTime (and receive from PineTime) for all our Bluetooth LE messages.</p>
<h2 id="go-interfaces-become-dart-abstract-classes" class="section-header"><a href="#go-interfaces-become-dart-abstract-classes">2.4 Go Interfaces Become Dart Abstract Classes</a></h2>
<p>We rewrite a Go <code>interface</code> (<a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/nmxact/nmp/nmp.go#L53-L59"><code>nmxact/nmp/nmp.go</code></a>)...</p>
<pre><code class="language-go">//  In Go...
type NmpReq interface {
  Hdr() *NmpHdr
  SetHdr(hdr *NmpHdr)
</code></pre>
<p>...As a Dart <code>abstract class</code> (<a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/newtmgr.dart#L78-L86"><code>newtmgr.dart</code></a>)</p>
<pre><code class="language-dart">//  In Dart...
abstract class NmpReq {
  NmpHdr Hdr();
  void SetHdr(NmpHdr hdr);
</code></pre>
<p><code>NmpReq</code> is the abstract base class for Request Messages that we'll be transmitting to PineTime over Bluetooth LE.</p>
<h1 id="but-some-go-structs-become-dart-mixins" class="section-header"><a href="#but-some-go-structs-become-dart-mixins">3 But Some Go Structs Become Dart Mixins</a></h1>
<p>In some cases, a Go <code>struct</code> should be converted to a Dart <code>mixin</code>. Consider this Go <code>struct</code> defined in <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/nmxact/nmp/nmp.go#L67-L79"><code>nmxact/nmp/nmp.go</code></a>...</p>
<pre><code class="language-go">/// In Go...
/// SMP Base Message
type NmpBase struct {
  hdr NmpHdr `codec:&quot;-&quot;`
}

/// Get the SMP Message Header
func (b *NmpBase) Hdr() *NmpHdr {
  return &amp;b.hdr
}

/// Set the SMP Message Header
func (b *NmpBase) SetHdr(h *NmpHdr) {
  b.hdr = *h
}
</code></pre>
<p><code>NmpBase</code> appears to be a base class for Request and Response Messages.</p>
<p>But if we look closely at the above code, <code>NmpBase</code> is actually a helper class for getting and setting the Message Header for Request and Response Messages.</p>
<p>Helper classes are implemented in Dart as a <a href="https://dart.dev/guides/language/language-tour#adding-features-to-a-class-mixins"><code>mixin</code></a>. Here's our <code>mixin</code> implementation of <code>NmpBase</code> in <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/newtmgr.dart#L95-L107"><code>newtmgr.dart</code></a>...</p>
<pre><code class="language-dart">/// In Dart...
/// SMP Message Helper
mixin NmpBase {
  NmpHdr hdr;  //  Will not be encoded: `codec:&quot;-&quot;`
  
  /// Get the SMP Message Header
  NmpHdr Hdr() {
    return hdr;
  }
  
  /// Set the SMP Message Header
  void SetHdr(NmpHdr h) {
    hdr = h;
  }
}
</code></pre>
<p>We use our <code>NmpBase mixin</code> like this (<a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/newtmgr.dart#L345-L377"><code>newtmgr.dart</code></a>)...</p>
<pre><code class="language-dart">/// In Dart...
/// SMP Request Message to Read Image State
class ImageStateReadReq 
  with NmpBase       //  Mixin to get and set SMP Message Header
  implements NmpReq  //  Interface for SMP Request Message  
{
  /// Get the SMP Request Message
  NmpMsg Msg() { return MsgFromReq(this); }

  /// Encode the SMP Request Message fields to CBOR
  void Encode(cbor.MapBuilder builder) {
      //  Encode an empty body
  }
}
</code></pre>
<p><em>How are the Dart message classes and mixins connected?</em></p>
<p>Like this...</p>
<p><img src="https://lupyuen.github.io/images/companion-class.png" alt="Message Class and Mixin for PineTime Companion App" /></p>
<p>It looks complicated, and yes we need to understand the Go code before converting to Dart.</p>
<p>Go uses <a href="https://benhoyt.com/writings/go-intro/">&quot;Static Duck Typing&quot;</a> thus it's not obvious whether a Go <code>struct</code> should be a Dart <code>class</code>, <code>abstract class</code> or <code>mixin</code>. But with a bit of practice... We'll get the hang of it!</p>
<h1 id="convert-go-arrays-to-dart" class="section-header"><a href="#convert-go-arrays-to-dart">4 Convert Go Arrays to Dart</a></h1>
<p>Let's convert this Go code that creates a byte array and appends some bytes: <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/nmxact/nmp/nmp.go#L111-L115"><code>nmxact/nmp/nmp.go</code></a></p>
<pre><code class="language-go">//  In Go: Create a byte array with max size NMP_HDR_SIZE
buf := make([]byte, 0, NMP_HDR_SIZE)

//  Append bytes to the array
buf = append(buf, byte(hdr.Op))
buf = append(buf, byte(hdr.Flags))
</code></pre>
<p>In Dart we use <code>typed.Uint8Buffer</code> to represent a byte buffer. It works like a Dart List, so we may call <code>add()</code> to add bytes: <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/newtmgr.dart#L48-L66"><code>newtmgr.dart</code></a></p>
<pre><code class="language-dart">//  In Dart: Create a byte buffer
var buf = typed.Uint8Buffer();

//  Append bytes to the byte buffer
buf.add(this.Op);
buf.add(this.Flags);
...
//  Verify the buffer has size NMP_HDR_SIZE
assert(buf.length == NMP_HDR_SIZE);
</code></pre>
<p>To add a Dart List to another List, we call <code>addAll()</code>: <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/newtmgr.dart#L55-L57"><code>newtmgr.dart</code></a></p>
<pre><code class="language-dart">//  In Dart: Convert 16-bit length to a list of 2 bytes
typed.Uint8Buffer u16b = binaryBigEndianPutUint16(this.Len);

//  Append the 2 bytes to the byte buffer
buf.addAll(u16b);
</code></pre>
<p>Now let's probe deeper into the Go code and understand how it sends Bluetooth LE commands to PineTime.</p>
<p><img src="https://lupyuen.github.io/images/companion-newtmgrsize.png" alt="Newt Manager with over 100 Go source files" /></p>
<h1 id="dive-deep-into-go-and-newt-manager" class="section-header"><a href="#dive-deep-into-go-and-newt-manager">5 Dive Deep into Go and Newt Manager</a></h1>
<p><em>The Go code in this article that connects to PineTime Smart Watch over Bluetooth LE... Where does it come from?</em></p>
<p>The Go code comes from <a href="https://github.com/apache/mynewt-newtmgr"><strong>Newt Manager</strong></a>, the Linux command line tool that updates PineTime's firmware over Bluetooth LE. Newt Manager implements the Simple Management Protocol for talking to PineTime's Firmware Update Service.</p>
<p><em>Newt Manager has over a hundred Go source files... Which source files should we convert to Dart?</em></p>
<p><a href="https://blog.gopheracademy.com/advent-2017/go-execution-tracer/"><strong>Go Tracing</strong></a> can help! Let's enable Go Tracing like this: <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/newtmgr/newtmgr.go"><code>newtmgr.go</code></a></p>
<pre><code class="language-go">import &quot;runtime/trace&quot;

func main() {
  trace.Start(os.Stderr)
  defer trace.Stop()
  ...
</code></pre>
<p>This tells the Go Tracing Library to dump the traces to Standard Error.</p>
<p>Here's how we run Newt Manager to transmit a command to PineTime (list firmware images) and capture the Go Tracing data...</p>
<pre><code class="language-bash"># Install graphviz for Go tracing
sudo apt install graphviz

# Download Newt Manager
cd ~/go
mkdir -p src/mynewt.apache.org
cd src/mynewt.apache.org/
git clone https://github.com/lupyuen/mynewt-newtmgr
mv mynewt-newtmgr newtmgr

# TODO: Edit the source files to enable Go tracing

# Build Newt Manager
cd ~/go/src/mynewt.apache.org/newtmgr/newtmgr
export GO111MODULE=on
go build

# Run Newt Manager and add connection for PineTime
cd ~/go/src/mynewt.apache.org/newtmgr/newtmgr
sudo ./newtmgr conn add pinetime type=ble connstring=&quot;peer_name=pinetime&quot; 2&gt; /dev/null

# Run Newt Manager and list firmware images on PineTime
sudo ./newtmgr image list -c pinetime 2&gt; trace.out

# Display the captured Go trace in a web browser
go tool trace trace.out
</code></pre>
<p>The Go Tracing web page appears, showing the following links...</p>

<pre><code>  View trace
  Goroutine analysis
  Network blocking profile (⬇)
  Synchronization blocking profile (⬇)
  Syscall blocking profile (⬇)
  Scheduler latency profile (⬇)
  User-defined tasks
  User-defined regions
  Minimum mutator utilization</code></pre>
<p>Click <code>Synchronization Blocking Profile</code> to show a <a href="https://lupyuen.github.io/images/companion-tracedelay.pdf">highly detailed graph of the Go function calls</a>...</p>
<p><img src="https://lupyuen.github.io/images/companion-tracedelay.png" alt="Call Graph from Go Trace" /></p>
<p><a href="https://lupyuen.github.io/images/companion-tracedelay.pdf"><em>PDF version</em></a></p>
<p>Now we know which Go functions were called to list firmware images on PineTime... But soooo many functions!</p>
<p>Let's eliminate the Go modules <code>bll</code>, <code>ble</code> and the stuff underneath... These Bluetooth LE functions are already implemented in Dart by <code>flutter_blue</code>.</p>
<p>What's remaining is this <code>xact</code> trail of Go function calls...</p>
<p><img src="https://lupyuen.github.io/images/companion-tracedelay2.png" alt="Call Graph highlighting the code to be converted" /></p>
<p>That's why we chose to convert code like <code>ImageStateReadCmd</code> to Dart... Because it was called when Newt Manager connected to PineTime to query its firmware images.</p>
<p>Some functions (like <code>BodyBytes</code> below) may not appear in Go Tracing because they are invoked by Bluetooth callbacks. We may force them to appear in Go Tracing like this...</p>
<pre><code class="language-go">import (
  &quot;context&quot;
  &quot;runtime/trace&quot;
  &quot;time&quot;
)

func BodyBytes(body interface{}) ([]byte, error) {
  _, task := trace.NewTask(
    context.Background(), 
    &quot;nmxact/nmp/nmp.go/BodyBytes&quot;
  )
  time.Sleep(100 * time.Millisecond)
  defer task.End()
  ...
</code></pre>
<p>In the Go Tracing web page, click <code>User-Defined Tasks</code> to see the traces...</p>
<p><img src="https://lupyuen.github.io/images/companion-tracetasks.png" alt="Go Trace for User Defined Tasks" /></p>
<p><em>Why did we sleep 100 milliseconds during tracing?</em></p>
<p>So that we can look at the call duration in the above chart... And figure out which Go function is calling which other function.</p>
<h1 id="cbor-encoding-in-dart" class="section-header"><a href="#cbor-encoding-in-dart">6 CBOR Encoding in Dart</a></h1>
<p>There's something odd about the Bluetooth LE messages that we transmit to (and receive from) PineTime...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="number">00000000</span>                           <span class="ident">bf</span> <span class="number">66</span> <span class="number">69</span> <span class="number">6d</span> <span class="number">61</span> <span class="number">67</span> <span class="number">65</span> <span class="number">73</span>  <span class="op">|</span>        .<span class="ident">fimages</span><span class="op">|</span>
<span class="number">00000010</span>  <span class="number">9f</span> <span class="ident">bf</span> <span class="number">64</span> <span class="number">73</span> <span class="number">6c</span> <span class="number">6f</span> <span class="number">74</span> <span class="number">00</span>  <span class="number">67</span> <span class="number">76</span> <span class="number">65</span> <span class="number">72</span> <span class="number">73</span> <span class="number">69</span> <span class="number">6f</span> <span class="number">6e</span>  <span class="op">|</span>..<span class="ident">dslot</span>.<span class="ident">gversion</span><span class="op">|</span>
<span class="number">00000020</span>  <span class="number">65</span> <span class="number">31</span> <span class="number">2e</span> <span class="number">30</span> <span class="number">2e</span> <span class="number">30</span> <span class="number">64</span> <span class="number">68</span>  <span class="number">61</span> <span class="number">73</span> <span class="number">68</span> <span class="number">58</span> <span class="number">20</span> <span class="number">70</span> <span class="number">3e</span> <span class="ident">bb</span>  <span class="op">|</span><span class="ident">e1</span>.<span class="number">0.0dhashX</span> <span class="ident">p</span><span class="op">&gt;</span>.<span class="op">|</span>
<span class="number">00000030</span>  <span class="ident">f8</span> <span class="number">11</span> <span class="number">45</span> <span class="number">8b</span> <span class="number">1f</span> <span class="ident">ad</span> <span class="number">18</span> <span class="number">9e</span>  <span class="number">64</span> <span class="ident">e3</span> <span class="ident">a5</span> <span class="ident">e0</span> <span class="ident">f8</span> <span class="number">09</span> <span class="ident">cb</span> <span class="ident">e6</span>  <span class="op">|</span>..<span class="ident">E</span>.....<span class="ident">d</span>.......<span class="op">|</span>
<span class="number">00000040</span>  <span class="ident">ba</span> <span class="ident">d8</span> <span class="number">83</span> <span class="ident">c7</span> <span class="number">6b</span> <span class="number">3d</span> <span class="ident">d7</span> <span class="number">12</span>  <span class="number">79</span> <span class="number">1c</span> <span class="number">82</span> <span class="number">2f</span> <span class="ident">b5</span> <span class="number">68</span> <span class="number">62</span> <span class="number">6f</span>  <span class="op">|</span>....<span class="ident">k</span><span class="op">=</span>..<span class="ident">y</span>..<span class="op">/</span>.<span class="ident">hbo</span><span class="op">|</span>
<span class="number">00000050</span>  <span class="number">6f</span> <span class="number">74</span> <span class="number">61</span> <span class="number">62</span> <span class="number">6c</span> <span class="number">65</span> <span class="ident">f5</span> <span class="number">67</span>  <span class="number">70</span> <span class="number">65</span> <span class="number">6e</span> <span class="number">64</span> <span class="number">69</span> <span class="number">6e</span> <span class="number">67</span> <span class="ident">f4</span>  <span class="op">|</span><span class="ident">otable</span>.<span class="ident">gpending</span>.<span class="op">|</span>
<span class="number">00000060</span>  <span class="number">69</span> <span class="number">63</span> <span class="number">6f</span> <span class="number">6e</span> <span class="number">66</span> <span class="number">69</span> <span class="number">72</span> <span class="number">6d</span>  <span class="number">65</span> <span class="number">64</span> <span class="ident">f5</span> <span class="number">66</span> <span class="number">61</span> <span class="number">63</span> <span class="number">74</span> <span class="number">69</span>  <span class="op">|</span><span class="ident">iconfirmed</span>.<span class="ident">facti</span><span class="op">|</span>
<span class="number">00000070</span>  <span class="number">76</span> <span class="number">65</span> <span class="ident">f5</span> <span class="number">69</span> <span class="number">70</span> <span class="number">65</span> <span class="number">72</span> <span class="number">6d</span>  <span class="number">61</span> <span class="number">6e</span> <span class="number">65</span> <span class="number">6e</span> <span class="number">74</span> <span class="ident">f4</span> <span class="ident">ff</span> <span class="ident">ff</span>  <span class="op">|</span><span class="ident">ve</span>.<span class="ident">ipermanent</span>...<span class="op">|</span>
<span class="number">00000080</span>  <span class="number">6b</span> <span class="number">73</span> <span class="number">70</span> <span class="number">6c</span> <span class="number">69</span> <span class="number">74</span> <span class="number">53</span> <span class="number">74</span>  <span class="number">61</span> <span class="number">74</span> <span class="number">75</span> <span class="number">73</span> <span class="number">00</span> <span class="ident">ff</span>        <span class="op">|</span><span class="ident">ksplitStatus</span>..<span class="op">|</span> </pre></div>
<p><em>Why is there a mix of ASCII text and binary data in the message?</em></p>
<p>That's because our Bluetooth LE messages are encoded in <a href="https://en.wikipedia.org/wiki/CBOR"><strong>Concise Binary Object Representation (CBOR)</strong></a>!</p>
<p>CBOR is like a compact binary form of JSON. The above chunk of data is equivalent to this human-readable JSON...</p>
<pre><code class="language-json">{
    &quot;images&quot;: [
        {
            &quot;slot&quot;: 0,
            &quot;version&quot;: &quot;1.0.0&quot;,
            &quot;hash&quot;: [ 112, 62, 187, 248, 17, 69, 139, 31, 173, 24, 158, 100, 227, 165, 224, 248, 9, 203, 230, 186, 216, 131, 199, 107, 61, 215, 18, 121, 28, 130, 47, 181 ],
            &quot;bootable&quot;:  true,
            &quot;pending&quot;:   false,
            &quot;confirmed&quot;: true,
            &quot;active&quot;:    true,
            &quot;permanent&quot;: false
        }
    ],
    &quot;splitStatus&quot;: 0
}
</code></pre>
<p>Comparing their sizes...</p>
<ul>
<li><strong>JSON</strong> is <strong>264</strong> bytes</li>
<li><strong>CBOR</strong> is <strong>134</strong> bytes</li>
</ul>
<p>CBOR is half the size of JSON! Wow!</p>
<p>In Newt Manager (the Go code that runs on Linux), we encode a Go  <code>struct</code> into CBOR like this: <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/nmxact/nmp/nmp.go#L129-L144"><code>nmxact/nmp/nmp.go</code></a></p>
<pre><code class="language-go">//  In Go...
//  Import the codec library for CBOR Encoding and Decoding: https://godoc.org/github.com/ugorji/go/codec
import &quot;github.com/ugorji/go/codec&quot;
    
/// Encode SMP Request Body with CBOR and return the byte array
func BodyBytes(body interface{}) ([]byte, error) {
    data := make([]byte, 0)
    enc := codec.NewEncoderBytes(&amp;data, new(codec.CborHandle))
    if err := enc.Encode(body); err != nil {
        return nil, fmt.Errorf(&quot;Failed to encode message %s&quot;, err.Error())
    }
    log.Debugf(&quot;Encoded %+v to:\n%s&quot;, body, hex.Dump(data))
    return data, nil
}
</code></pre>
<p>Here's the equivalent code in Dart that encodes our Dart <code>class</code> into a Bluetooth LE message: <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/newtmgr.dart#L141-L176"><code>newtmgr.dart</code></a></p>
<pre><code class="language-dart">//  In Dart...
//  Import the CBOR Encoder and Decoder library: https://pub.dev/packages/cbor
import 'package:cbor/cbor.dart' as cbor;

/// Encode SMP Request Body with CBOR and return the byte array
typed.Uint8Buffer BodyBytes(  //  Previously returns []byte
  NmpReq body                 //  Previously interface{}
) {
  //  Get our CBOR instance. Always do this, it correctly initialises the decoder.
  final inst = cbor.Cbor();

  //  Get our encoder and map builder
  final encoder = inst.encoder;
  final mapBuilder = cbor.MapBuilder.builder();

  //  Encode the body as a CBOR map
  body.Encode(mapBuilder);
  final mapData = mapBuilder.getData();
  encoder.addBuilderOutput(mapData);

  //  Get the encoded body
  final data = inst.output.getData();

  //  Decode the encoded body and pretty print it
  inst.decodeFromInput();
  final hdr = body.Hdr();
  print(
    &quot;Encoded {NmpBase:{hdr:{&quot;
    &quot;Op:${ hdr.Op } &quot;
    &quot;Flags:${ hdr.Flags } &quot;
    &quot;Len:${ hdr.Len } &quot;
    &quot;Group:${ hdr.Group } &quot;
    &quot;Seq:${ hdr.Seq } &quot;
    &quot;Id:${ hdr.Id }}}} &quot;
    &quot;${ inst.decodedToJSON() } &quot;
    &quot;to:\n${ hexDump(data) }&quot;
  );

  //  Return the encoded data
  return data;
}
</code></pre>
<p>Yep the Dart code for encoding CBOR looks longer than Go... And we're not done yet!</p>
<p>For each specific type of message, we need to write Dart code to <strong>encode each field of the message</strong>.</p>
<p>Here's the request message <code>ImageStateReadReq</code> that we'll be transmitting to PineTime (to query the firmware inside): <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/newtmgr.dart#L345-L376"><code>newtmgr.dart</code></a></p>
<pre><code class="language-dart">class ImageStateReadReq 
  with NmpBase       //  Get and set SMP Message Header
  implements NmpReq  //  SMP Request Message  
{
  //  No message fields needed

  /// Encode the SMP Request fields to CBOR
  void Encode(cbor.MapBuilder builder) {
    //  No message fields needed, so we encode an empty map: {}
  }
}
</code></pre>
<p><code>ImageStateReadReq</code> doesn't have any message fields, so the <code>Encode()</code> method is empty.  The message is encoded as an empty map: <code>{}</code></p>
<p>For other messages, the <code>Encode()</code> method will encode the message fields (key and value) like this...</p>
<pre><code class="language-dart">builder.writeString('slot');  //  Key
builder.writeInt(0);          //  Integer Value

builder.writeString('version');  //  Key
builder.writeString('1.0.0');    //  String Value

builder.writeString('hash');  //  Key
builder.writeArray(&lt;int&gt;[112, 62, 187, 248, 17, 69, 139, 31, 173, 24, 158, 100, 227, 165, 224, 248, 9, 203, 230, 186, 216, 131, 199, 107, 61, 215, 18, 121, 28, 130, 47, 181]);  //  Byte Array Value
</code></pre>
<p>This field encoding code is missing from Go because the CBOR Encoder in Go uses Field Tags (like <code>codec:&quot;slot&quot;</code>). Check this for an example of CBOR field encoding in Go: <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/nmxact/nmp/image.go#L97-L108"><code>nmxact/nmp/image.go</code></a></p>
<h1 id="test-dart-code-on-command-line" class="section-header"><a href="#test-dart-code-on-command-line">7 Test Dart Code on Command Line</a></h1>
<p>Now that we have the Dart code to create a CBOR request message for PineTime... Let's test it!</p>
<p>Dart makes testing really easy because Dart programs can be run from the command line.</p>
<p>First we add a <code>main()</code> function that creates a CBOR request message: <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/newtmgr.dart#L646-L661"><code>newtmgr.dart</code></a></p>
<pre><code class="language-dart">/// Our Dart program starts jere
void main() {
  //  Compose a CBOR request for PineTime
  composeRequest();
}

/// Compose a request to query firmware images on PineTime
typed.Uint8Buffer composeRequest() {
  //  Create the SMP Request
  final req = NewImageStateReadReq();

  //  Encode the SMP Message with CBOR
  final msg = req.Msg();
  final data = EncodeNmpPlain(msg);
  return data;
}
</code></pre>
<p>Add the dependent libraries to <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/pubspec.yaml"><code>pubspec.yaml</code></a>...</p>
<pre><code class="language-yaml">name: newtmgr

dependencies:
  cbor:       ^3.2.0  #  CBOR Encoder and Decoder. From https://pub.dev/packages/cbor
  typed_data: ^1.1.6  #  Helpers for Byte Buffers. From https://pub.dev/packages/typed_data
</code></pre>
<p>Download the Dart SDK: <a href="https://dart.dev/get-dart"><code>dart.dev</code></a></p>
<p>If we're using 32-bit ARMv7 (like Pinebook Pro or Raspberry Pi), browse to the <a href="https://dart.dev/tools/sdk/archive">Dart SDK Archive</a> and download the <strong>Linux ARMv7 Dart SDK</strong>.</p>
<p>Unzip to <code>~/dartsdk</code>. Edit <code>~/.bashrc</code> (or equivalent) and add <code>dartsdk/bin</code> to <code>PATH</code>...</p>
<pre><code class="language-bash">export PATH=$PATH:$HOME/dartsdk/bin
</code></pre>
<p>If we're using VSCode: Install the <a href="https://marketplace.visualstudio.com/items?itemName=Dart-Code.dart-code">Dart Extension for VSCode</a></p>
<p>Compile and run our dart program...</p>
<pre><code class="language-bash">pub get
dart newtmgr.dart 
</code></pre>
<p>We'll see this...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">Encoded</span> {<span class="ident">NmpBase</span>:{<span class="ident">hdr</span>:{<span class="ident">Op</span>:<span class="number">0</span> <span class="ident">Flags</span>:<span class="number">0</span> <span class="ident">Len</span>:<span class="number">0</span> <span class="ident">Group</span>:<span class="number">1</span> <span class="ident">Seq</span>:<span class="number">187</span> <span class="ident">Id</span>:<span class="number">0</span>}}} {} <span class="ident">to</span>:
<span class="ident">a0</span>
<span class="ident">Encoded</span>:
<span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">01</span> <span class="ident">bb</span> <span class="number">00</span> <span class="ident">a0</span></pre></div>
<p><em>How did we get the 9 bytes <code>00</code> ... <code>a0</code> for our PineTime request message?</em></p>
<p><code>a0</code> is the CBOR Encoding for the empty Message Body <code>{}</code>. Yep CBOR needs only one byte to encode the two-byte JSON!</p>
<p>The preceding 8 bytes <code>00 00 00 01 00 01 bb 00</code> are the Message Header, defined in <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/newtmgr.dart#L29-L37"><code>newtmgr.dart</code></a></p>
<pre><code class="language-dart">/// SMP Message Header
class NmpHdr {
  int Op;    //  Previously int8, 3 bits of opcode
  int Flags; //  Previously uint8
  int Len;   //  Previously uint16
  int Group; //  Previously uint16
  int Seq;   //  Previously uint8
  int Id;    //  Previously uint8
</code></pre>
<p>According to the <a href="https://github.com/apache/mynewt-mcumgr">Simple Managememt Protocol</a> definition from <a href="https://github.com/apache/mynewt-mcumgr/blob/master/mgmt/include/mgmt/mgmt.h"><code>mgmt.h</code></a>...</p>
<table><thead><tr><th align="left">Header Field</th><th align="left">Value</th><th align="left">Description</th></tr></thead><tbody>
<tr><td align="left"><code>Op</code></td><td align="left"><code>00</code></td><td align="left"><a href="https://github.com/apache/mynewt-mcumgr/blob/master/mgmt/include/mgmt/mgmt.h#L33-L37">Operation Code</a> (0 for Read Request)</td></tr>
<tr><td align="left"><code>Flags</code></td><td align="left"><code>00</code></td><td align="left">Unused</td></tr>
<tr><td align="left"><code>Len</code></td><td align="left"><code>00 01</code></td><td align="left">Length of Message Body</td></tr>
<tr><td align="left"><code>Group</code></td><td align="left"><code>00 01</code></td><td align="left"><a href="https://github.com/apache/mynewt-mcumgr/blob/master/mgmt/include/mgmt/mgmt.h#L39-L53">Group ID</a> (1 for Image Management)</td></tr>
<tr><td align="left"><code>Seq</code></td><td align="left"><code>bb</code></td><td align="left">Message Sequence Number (first number is random, subsequent numbers are sequential)</td></tr>
<tr><td align="left"><code>Id</code></td><td align="left"><code>00</code></td><td align="left">Message ID (0 for Image Listing)</td></tr>
</tbody></table>
<p>Thus we have created a valid PineTime Request Message that will list the firmware images stored in PineTime.</p>
<p>In a while we'll integrate this tested Dart code into our Flutter mobile app for Android and iOS. And watch happens when we send this Request Message to PineTime over Bluetooth LE!</p>
<p><a href="(https://github.com/apache/mynewt-mcumgr)">More about Simple Management Protocol</a></p>
<p><a href="https://github.com/apache/mynewt-mcumgr/blob/master/smp/include/smp/smp.h">SMP Message Format</a></p>
<p>For more about Dart and Flutter testing, check the <a href="https://dart.dev/guides/testing">Dart Testing Guide</a></p>
<h1 id="add-dart-code-to-flutter-app" class="section-header"><a href="#add-dart-code-to-flutter-app">8 Add Dart Code to Flutter App</a></h1>
<p>Let's add our new Dart code (for composing PineTime request messages) to the Bluetooth LE Flutter App from our previous article...</p>
<p><em><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/flutter">&quot;Your First Bluetooth Low Energy App with Flutter&quot;</a></em></p>
<p>Here's the new repository for our integrated Flutter App:</p>
<p><a href="https://github.com/lupyuen/pinetime-companion"><code>github.com/lupyuen/pinetime-companion</code></a></p>
<p>We take the Dart code from <a href="https://github.com/lupyuen/mynewt-newtmgr/blob/master/newtmgr.dart"><code>mynewt-newtmgr/newtmgr.dart</code></a> and add it to the new repository at <a href="https://github.com/lupyuen/pinetime-companion/blob/master/lib/newtmgr.dart"><code>pinetime-companion//lib/newtmgr.dart</code></a></p>
<p>Let's find the right spot to inject our new code, to compose a PineTime request message and transmit to PineTime: <a href="https://github.com/lupyuen/pinetime-companion/blob/master/lib/main.dart#L154-L197"><code>main.dart</code></a></p>
<pre><code class="language-dart">/// Screen that displays GATT Services and Characteristics for a Bluetooth LE device
class DeviceScreen extends StatelessWidget {
  ...
  /// Return a list of widgets that renders the GATT Services and Characteristics
  List&lt;Widget&gt; _buildServiceTiles(List&lt;BluetoothService&gt; services) {
    return services
        //  For each GATT Service...
        .map(
          //  Render the GATT Service
          (s) =&gt; ServiceTile(
            service: s,
            characteristicTiles: s.characteristics
              //  For each GATT Characteristic...
              .map(
                //  Render the GATT Characteristic and the Read, Write, Notify icons
                (c) =&gt; CharacteristicTile(
                  characteristic: c,

                  /// When the Read icon is pressed: Read the GATT Characteristic
                  onReadPressed: () =&gt; c.read(),

                  /// When the Write icon is pressed...
                  onWritePressed: () async {
                    //  Write our PineTime Request Message to the GATT Characteristic
                    await c.write(_getRequestBytes(), withoutResponse: true);
                    //  Causes read not ready exception:
                    //  await c.read();
                  },

                  /// When the Notify icon is pressed...
                  onNotificationPressed: () async {
                    //  Subcribe to notifications from the GATT Characteristic
                    await c.setNotifyValue(!c.isNotifying);
                    //  Causes read not ready exception:
                    //  await c.read();
                  },
</code></pre>
<p>The above code renders the GATT Services and Characteristics exposed by PineTime over Bluetooth LE...</p>
<p><img src="https://lupyuen.github.io/images/companion-characteristic.png" alt="Characteristic Tile with Read, Write, Notify icons" /></p>
<p>In the code above we have set an event handler on the Write icon to transmit our request message to PineTime... </p>
<pre><code class="language-dart">/// When the Write icon is pressed...
onWritePressed: () async {
  //  Write our PineTime Request Message to the GATT Characteristic
  await c.write(_getRequestBytes(), withoutResponse: true);
</code></pre>
<p>That's how we transmit requests to PineTime: We write to the GATT Characteristic that's defined by the <a href="https://github.com/apache/mynewt-mcumgr">Simple Management Protocol</a>.</p>
<p>(Simple Management Protocol is exposed by PineTime as Service <code>8D53DC1D-1DB7-4CD3-868B-8A527460AA84</code>, Characteristic <code>DA2E7828-FBCE-4E01-AE9E-261174997C48</code>, shortened to <code>0xDC1D</code> and <code>0x7828</code> respectively in the screen above)</p>
<p>Tapping the Write icon will trigger our function <code>_getRequestBytes()</code> defined in <a href="https://github.com/lupyuen/pinetime-companion/blob/master/lib/main.dart#L154-L197"><code>main.dart</code></a></p>
<pre><code class="language-dart">//  Import the Dart code for composing PineTime requests
import 'newtmgr.dart';

/// Screen that displays GATT Services and Characteristics for a Bluetooth LE device
class DeviceScreen extends StatelessWidget {
  ...
  /// Compose a PineTime Request Message and return the message bytes
  List&lt;int&gt; _getRequestBytes() {
    final data = composeRequest();
    return data;
  }
</code></pre>
<p>We have seen <code>composeRequest()</code> in the previous section. This is our new function that composes a PineTime request message.</p>
<p>We add the dependent Dart libraries to <a href="https://github.com/lupyuen/pinetime-companion/blob/14df42acb796de6a8f60ace1994d3d39c0f9fb5d/pubspec.yaml#L8-L12"><code>pubspec.yaml</code></a>...</p>
<pre><code class="language-yaml">dependencies:
  cbor:         ^3.2.0  #  CBOR Encoder and Decoder. From https://pub.dev/packages/cbor
  typed_data:   ^1.1.6  #  Helpers for Byte Buffers. From https://pub.dev/packages/typed_data
</code></pre>
<p>And we're ready to run this on a real phone!</p>
<p><em>The Flutter code is getting harder to read... And we haven't handled the PineTime response messages yet! How shall we fix this?</em></p>
<p>We may use the <a href="https://bloclibrary.dev/#/">Bloc State Management Library</a> to keep the code modular.</p>
<p>Tapping the icons and handling responses from PineTime may be treated as a <strong>stream of events</strong> that the Bloc framework will consume to transform the current state. (Think <a href="https://react-redux.js.org/">React Redux</a>)</p>
<p>Check out this Flutter App built with Bloc: <a href="https://bloclibrary.dev/#/flutterweathertutorial"><code>flutterweathertutorial</code></a></p>
<h1 id="run-our-flutter-app" class="section-header"><a href="#run-our-flutter-app">9 Run Our Flutter App</a></h1>
<p>Here's the video of our Flutter App running on a real Android phone. The app sends the <code>ImageStateReadReq</code> request to PineTime over Bluetooth LE to query the firmware images stored in PineTime...</p>
<ul>
<li>
<p><a href="https://youtu.be/n396JA62NDk">Watch on YouTube</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/releases/download/v4.2.3/companion-query-firmware.mov">Download the video</a></p>
</li>
</ul>
<p>Here's the response from PineTime...</p>
<p><img src="https://lupyuen.github.io/images/companion-response.png" alt="Flutter Companion App showing response from PineTime Smart Watch" /></p>
<p>The response is truncated because we haven't implemented response processing.</p>
<p><em>In the demo, why did we subscribe to GATT Notifications from PineTime? Why not just read the GATT Characteristic to get the response from PineTime?</em></p>
<p>That's how the <a href="https://github.com/apache/mynewt-mcumgr">Simple Managememt Protocol</a> works...</p>
<ol>
<li>
<p>We send a request to PineTime by <strong>writing to the GATT Characteristic</strong></p>
</li>
<li>
<p>Response from PineTime will be <strong>returned as a GATT Notification</strong></p>
</li>
</ol>
<p>This kind of Asynchronous Messaging is common for networking apps.</p>
<p><em>The response from PineTime appears truncated in our unfinished app. What does the entire response look like?</em></p>
<p>The full response message from PineTime (returned via GATT Notification) looks like this...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="number">00000000</span>  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">86</span> <span class="number">00</span> <span class="number">01</span> <span class="number">42</span> <span class="number">00</span>  <span class="ident">bf</span> <span class="number">66</span> <span class="number">69</span> <span class="number">6d</span> <span class="number">61</span> <span class="number">67</span> <span class="number">65</span> <span class="number">73</span>  <span class="op">|</span>......<span class="ident">B</span>..<span class="ident">fimages</span><span class="op">|</span>
<span class="number">00000010</span>  <span class="number">9f</span> <span class="ident">bf</span> <span class="number">64</span> <span class="number">73</span> <span class="number">6c</span> <span class="number">6f</span> <span class="number">74</span> <span class="number">00</span>  <span class="number">67</span> <span class="number">76</span> <span class="number">65</span> <span class="number">72</span> <span class="number">73</span> <span class="number">69</span> <span class="number">6f</span> <span class="number">6e</span>  <span class="op">|</span>..<span class="ident">dslot</span>.<span class="ident">gversion</span><span class="op">|</span>
<span class="number">00000020</span>  <span class="number">65</span> <span class="number">31</span> <span class="number">2e</span> <span class="number">30</span> <span class="number">2e</span> <span class="number">30</span> <span class="number">64</span> <span class="number">68</span>  <span class="number">61</span> <span class="number">73</span> <span class="number">68</span> <span class="number">58</span> <span class="number">20</span> <span class="number">70</span> <span class="number">3e</span> <span class="ident">bb</span>  <span class="op">|</span><span class="ident">e1</span>.<span class="number">0.0dhashX</span> <span class="ident">p</span><span class="op">&gt;</span>.<span class="op">|</span>
<span class="number">00000030</span>  <span class="ident">f8</span> <span class="number">11</span> <span class="number">45</span> <span class="number">8b</span> <span class="number">1f</span> <span class="ident">ad</span> <span class="number">18</span> <span class="number">9e</span>  <span class="number">64</span> <span class="ident">e3</span> <span class="ident">a5</span> <span class="ident">e0</span> <span class="ident">f8</span> <span class="number">09</span> <span class="ident">cb</span> <span class="ident">e6</span>  <span class="op">|</span>..<span class="ident">E</span>.....<span class="ident">d</span>.......<span class="op">|</span>
<span class="number">00000040</span>  <span class="ident">ba</span> <span class="ident">d8</span> <span class="number">83</span> <span class="ident">c7</span> <span class="number">6b</span> <span class="number">3d</span> <span class="ident">d7</span> <span class="number">12</span>  <span class="number">79</span> <span class="number">1c</span> <span class="number">82</span> <span class="number">2f</span> <span class="ident">b5</span> <span class="number">68</span> <span class="number">62</span> <span class="number">6f</span>  <span class="op">|</span>....<span class="ident">k</span><span class="op">=</span>..<span class="ident">y</span>..<span class="op">/</span>.<span class="ident">hbo</span><span class="op">|</span>
<span class="number">00000050</span>  <span class="number">6f</span> <span class="number">74</span> <span class="number">61</span> <span class="number">62</span> <span class="number">6c</span> <span class="number">65</span> <span class="ident">f5</span> <span class="number">67</span>  <span class="number">70</span> <span class="number">65</span> <span class="number">6e</span> <span class="number">64</span> <span class="number">69</span> <span class="number">6e</span> <span class="number">67</span> <span class="ident">f4</span>  <span class="op">|</span><span class="ident">otable</span>.<span class="ident">gpending</span>.<span class="op">|</span>
<span class="number">00000060</span>  <span class="number">69</span> <span class="number">63</span> <span class="number">6f</span> <span class="number">6e</span> <span class="number">66</span> <span class="number">69</span> <span class="number">72</span> <span class="number">6d</span>  <span class="number">65</span> <span class="number">64</span> <span class="ident">f5</span> <span class="number">66</span> <span class="number">61</span> <span class="number">63</span> <span class="number">74</span> <span class="number">69</span>  <span class="op">|</span><span class="ident">iconfirmed</span>.<span class="ident">facti</span><span class="op">|</span>
<span class="number">00000070</span>  <span class="number">76</span> <span class="number">65</span> <span class="ident">f5</span> <span class="number">69</span> <span class="number">70</span> <span class="number">65</span> <span class="number">72</span> <span class="number">6d</span>  <span class="number">61</span> <span class="number">6e</span> <span class="number">65</span> <span class="number">6e</span> <span class="number">74</span> <span class="ident">f4</span> <span class="ident">ff</span> <span class="ident">ff</span>  <span class="op">|</span><span class="ident">ve</span>.<span class="ident">ipermanent</span>...<span class="op">|</span>
<span class="number">00000080</span>  <span class="number">6b</span> <span class="number">73</span> <span class="number">70</span> <span class="number">6c</span> <span class="number">69</span> <span class="number">74</span> <span class="number">53</span> <span class="number">74</span>  <span class="number">61</span> <span class="number">74</span> <span class="number">75</span> <span class="number">73</span> <span class="number">00</span> <span class="ident">ff</span>        <span class="op">|</span><span class="ident">ksplitStatus</span>..<span class="op">|</span></pre></div>
<p>The response message structure is similar to the request message we have seen earlier...</p>
<ul>
<li>
<p>Message Header: 8 bytes, followed by...</p>
</li>
<li>
<p>Message Body: Encoded in <a href="https://en.wikipedia.org/wiki/CBOR">CBOR</a></p>
</li>
</ul>
<p>Here's the Message Header according to the definition in <a href="https://github.com/apache/mynewt-mcumgr/blob/master/mgmt/include/mgmt/mgmt.h"><code>mgmt.h</code></a>...</p>
<table><thead><tr><th align="left">Header Field</th><th align="left">Value</th><th align="left">Description</th></tr></thead><tbody>
<tr><td align="left"><code>Op</code></td><td align="left"><code>01</code></td><td align="left"><a href="https://github.com/apache/mynewt-mcumgr/blob/master/mgmt/include/mgmt/mgmt.h#L33-L37">Operation Code</a> (1 for Read Response)</td></tr>
<tr><td align="left"><code>Flags</code></td><td align="left"><code>00</code></td><td align="left">Unused</td></tr>
<tr><td align="left"><code>Len</code></td><td align="left"><code>00 86</code></td><td align="left">Length of Message Body</td></tr>
<tr><td align="left"><code>Group</code></td><td align="left"><code>00 01</code></td><td align="left"><a href="https://github.com/apache/mynewt-mcumgr/blob/master/mgmt/include/mgmt/mgmt.h#L39-L53">Group ID</a> (1 for Image Management)</td></tr>
<tr><td align="left"><code>Seq</code></td><td align="left"><code>42</code></td><td align="left">Message Sequence Number (should match the request message)</td></tr>
<tr><td align="left"><code>Id</code></td><td align="left"><code>00</code></td><td align="left">Message ID (0 for Image Listing)</td></tr>
</tbody></table>
<p>The message body (in CBOR format) decodes to this JSON...</p>
<pre><code class="language-json">{
    &quot;images&quot;: [
        {
            &quot;slot&quot;: 0,
            &quot;version&quot;: &quot;1.0.0&quot;,
            &quot;hash&quot;: [ 112, 62, 187, 248, 17, 69, 139, 31, 173, 24, 158, 100, 227, 165, 224, 248, 9, 203, 230, 186, 216, 131, 199, 107, 61, 215, 18, 121, 28, 130, 47, 181 ],
            &quot;bootable&quot;:  true,
            &quot;pending&quot;:   false,
            &quot;confirmed&quot;: true,
            &quot;active&quot;:    true,
            &quot;permanent&quot;: false
        }
    ],
    &quot;splitStatus&quot;: 0
}
</code></pre>
<p>This is a response from PineTime's firmware update service saying...</p>
<ol>
<li>
<p>I have one firmware image, stored in Slot 0 (Internal Flash ROM)</p>
</li>
<li>
<p>The firmware version number is <code>1.0.0</code></p>
</li>
<li>
<p>This firmware is active and has been confirmed OK</p>
</li>
</ol>
<p><em>Can PineTime store a second firmware image?</em></p>
<p>Yes in Slot 1, which is the Standby Firmware Slot in External SPI Flash. So the above response may contain up to two firmware images.</p>
<p>Slot 1 is used for staging new firmware images during updates, also for rolling back to the old firmware if the new firmware doesn't work.</p>
<p><em>Why does PineTime's firmware update service return a hash?</em></p>
<p>The hash will be used in subsequent commands when updating firmware or to roll back the firmware.</p>
<h1 id="whats-next" class="section-header"><a href="#whats-next">10 What's Next</a></h1>
<p>TODO</p>
<ol>
<li>
<p>Response Handling</p>
</li>
<li>
<p>Handle more requests and responses</p>
</li>
<li>
<p>Bloc Library</p>
</li>
<li>
<p>Companion App for PinePhone</p>
</li>
</ol>
<p>I'll be using the code in this article to create the open source <strong>PineTime Companion App</strong> for Android and iOS. So that we can flash our PineTime Smart Watches wirelessly, sync the date and time, show notifications, chart our heart rate, ...</p>
<p>Flutter makes it really easy to maintain a single code base for Android and iOS... And <code>flutter_blue</code> makes Bluetooth LE coding so simple!</p>
<p>If you're keen to help out, come chat with the PineTime FOSS Community (and me) in the PineTime Chatroom!</p>
<p><a href="https://wiki.pine64.org/index.php/PineTime#Community">PineTime Chatroom on Matrix / Discord / Telegram / IRC</a></p>
<h1 id="further-reading" class="section-header"><a href="#further-reading">11 Further Reading</a></h1>
<p><em><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/flutter">&quot;Your First Bluetooth Low Energy App with Flutter&quot;</a></em></p>
<p><em><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/mcuboot">&quot;MCUBoot Bootloader for PineTime Smart Watch (nRF52)&quot;</a></em></p>
<p><em><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/dfu">&quot;Firmware Update over Bluetooth Low Energy on PineTime Smart Watch&quot;</a></em></p>
<p><em><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/dfutest">&quot;Wireless Firmware Update In Action on PineTime Smart Watch (nRF52)&quot;</a></em></p>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/README.md">Check out the other PineTime articles</a></p>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>

    
</body>
</html>