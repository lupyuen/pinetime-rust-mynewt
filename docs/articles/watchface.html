<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Create Your Own PineTime Watch Face in Rust... And Publish on crates.io</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Create Your Own PineTime Watch Face in Rust... And Publish on crates.io" 
    data-rh="true">
<meta property="og:description" 
    content="How we build PineTime Watch Faces with Rust and LVGL... And publish them on crates.io" 
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/timesync-title.png">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Create Your Own PineTime Watch Face in Rust... And Publish on crates.io</h1>
    <nav id="TOC"><ul>
<li><a href="#create-watch-face">1 Create Watch Face</a><ul></ul></li>
<li><a href="#update-watch-face">2 Update Watch Face</a><ul>
<li><a href="#update-time-label">2.1 Update Time Label</a><ul></ul></li>
<li><a href="#update-date-label">2.2 Update Date Label</a><ul></ul></li>
<li><a href="#update-bluetooth-label">2.3 Update Bluetooth Label</a><ul></ul></li>
<li><a href="#update-power-label">2.4 Update Power Label</a><ul></ul></li></ul></li>
<li><a href="#discover-watch-faces-and-publish-your-own">3 Discover Watch Faces and Publish Your Own</a><ul></ul></li>
<li><a href="#build-and-flash-mynewt-firmware">4 Build and Flash Mynewt Firmware</a><ul>
<li><a href="#github-actions">4.1 GitHub Actions</a><ul></ul></li>
<li><a href="#gitlab-ci">4.2 GitLab CI</a><ul></ul></li>
<li><a href="#linux-macos-and-windows">4.3 Linux, macOS and Windows</a><ul></ul></li>
<li><a href="#flash-firmware-to-pinetime">4.4 Flash Firmware to PineTime</a><ul></ul></li>
<li><a href="#specify-the-watch-face">4.5 Specify the Watch Face</a><ul></ul></li></ul></li>
<li><a href="#whats-next">5 What's Next</a><ul>
<li><a href="#whos-driving">5.1 Who's Driving?</a><ul></ul></li>
<li><a href="#driving-education">5.2 Driving Education</a><ul></ul></li></ul></li>
<li><a href="#advanced-topic-webassembly-simulator">6 Advanced Topic: WebAssembly Simulator</a><ul></ul></li>
<li><a href="#advanced-topic-get-the-time">7 Advanced Topic: Get the Time</a><ul></ul></li>
<li><a href="#advanced-topic-watch-face-framework">8 Advanced Topic: Watch Face Framework</a><ul></ul></li>
<li><a href="#advanced-topic-rust-wrapper-for-lvgl">9 Advanced Topic: Rust Wrapper for LVGL</a><ul></ul></li></ul></nav><p><img src="https://lupyuen.github.io/images/timesync-title.png" alt="PineTime Smart Watch with Rust Watch Face" /></p>
<p><em>We can build Watch Faces for <a href="https://wiki.pine64.org/index.php/PineTime">PineTime Smart Watch</a> in C... Right?</em></p>
<p>Sure we can <a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/timesync#create-watch-face">create Watch Faces in C</a>. But as our Watch Face code in C grows in complexity... It becomes harder to test, deploy, maintain and extend.</p>
<p>Today we'll look at a more sustainable way to build Watch Faces... With a <strong>Watch Face Framework in Rust</strong>!</p>
<p>Rust Watch Faces may also be catalogued at <strong><a href="https://crates.io/crates/barebones-watchface">crates.io</a></strong>... So that PineTime Owners may easily discover, extend and remix the Watch Faces.</p>
<p>Let's learn how...</p>
<h1 id="create-watch-face" class="section-header"><a href="#create-watch-face">1 Create Watch Face</a></h1>
<p>Watch Faces are built in Rust with the <a href="https://crates.io/crates/pinetime-watchface"><strong>Watch Face Framework <code>pinetime-watchface</code></strong></a>.</p>
<p>Our Rust Watch Face needs to implement the <strong><code>WatchFace</code> Trait</strong> that's defined in <a href="https://github.com/lupyuen/pinetime-watchface/blob/master/src/lib.rs#L164-L190"><code>pinetime-watchface/blob/master/src/lib.rs</code></a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Watch Faces shall implement this trait</span>
<span class="kw">pub</span> <span class="kw">trait</span> <span class="ident">WatchFace</span> {
    <span class="doccomment">/// Create the widgets for the Watch Face</span>
    <span class="kw">fn</span> <span class="ident">new</span>() <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span><span class="self">Self</span><span class="op">&gt;</span>
        <span class="kw">where</span> <span class="self">Self</span>: <span class="ident">core</span>::<span class="ident">marker</span>::<span class="ident">Sized</span>;  <span class="comment">//  Result type must have known size</span>

    <span class="doccomment">/// Update the widgets in the Watch Face with the current state</span>
    <span class="kw">fn</span> <span class="ident">update</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">state</span>: <span class="kw-2">&amp;</span><span class="ident">WatchFaceState</span>) <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span>;
}</pre></div>
<p>(If you're new to Rust... A Trait in Rust works like an Interface in Java and TypeScript)</p>
<p>The <code>WatchFace</code> Trait says we need to define two functions...</p>
<ol>
<li>
<p><strong><code>new</code>:</strong> To create the Watch Face. This is called by the PineTime Firmware when PineTime starts.</p>
</li>
<li>
<p><strong><code>update</code>:</strong> To update the Watch Face with the current date and time. This is called every minute by the PineTime Firmware to refresh our Watch Face.</p>
</li>
</ol>
<p>Let's create a very simple Watch Face: <a href="https://crates.io/crates/barebones-watchface"><code>BarebonesWatchFace</code></a></p>
<p><img src="https://lupyuen.github.io/images/timesync-layout.png" alt="Watch Face Layout" /></p>
<p><a href="https://lupyuen.github.io/barebones-watchface/lvgl.html"><strong>Preview this Watch Face in your web browser</strong></a></p>
<p>Here's how we implement the <code>new</code> function to create our Watch Face: <a href="https://github.com/lupyuen/barebones-watchface/blob/master/src/lib.rs#L72-L129"><code>barebones-watchface/src/lib.rs</code></a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">impl</span> <span class="ident">WatchFace</span> <span class="kw">for</span> <span class="ident">BarebonesWatchFace</span> {

    <span class="doccomment">/// Create the widgets for the Watch Face</span>
    <span class="kw">fn</span> <span class="ident">new</span>() <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span><span class="self">Self</span><span class="op">&gt;</span> {
        <span class="comment">//  Get the active screen</span>
        <span class="kw">let</span> <span class="ident">screen</span> <span class="op">=</span> <span class="ident">watchface</span>::<span class="ident">get_active_screen</span>();

        <span class="comment">//  Create the widgets</span>
        <span class="kw">let</span> <span class="ident">watch_face</span> <span class="op">=</span> <span class="self">Self</span> {
            <span class="comment">//  Create a Label for Time: &quot;00:00&quot;</span>
            <span class="ident">time_label</span>: {
                <span class="kw">let</span> <span class="ident">lbl</span> <span class="op">=</span> <span class="ident">label</span>::<span class="ident">create</span>(<span class="ident">screen</span>, <span class="ident">ptr</span>::<span class="ident">null</span>()) <span class="question-mark">?</span> ;  <span class="comment">//  `?` will terminate the function in case of error</span>
                <span class="ident">label</span>::<span class="ident">set_long_mode</span>(<span class="ident">lbl</span>, <span class="ident">label</span>::<span class="ident">LV_LABEL_LONG_BREAK</span>) <span class="question-mark">?</span> ;
                <span class="ident">label</span>::<span class="ident">set_text</span>(     <span class="ident">lbl</span>, <span class="macro">strn</span><span class="macro">!</span>(<span class="string">&quot;00:00&quot;</span>)) <span class="question-mark">?</span> ;     <span class="comment">//  strn creates a null-terminated string</span>
                <span class="ident">obj</span>::<span class="ident">set_width</span>(      <span class="ident">lbl</span>, <span class="number">240</span>) <span class="question-mark">?</span> ;
                <span class="ident">obj</span>::<span class="ident">set_height</span>(     <span class="ident">lbl</span>, <span class="number">200</span>) <span class="question-mark">?</span> ;
                <span class="ident">label</span>::<span class="ident">set_align</span>(    <span class="ident">lbl</span>, <span class="ident">label</span>::<span class="ident">LV_LABEL_ALIGN_CENTER</span>) <span class="question-mark">?</span> ;
                <span class="ident">obj</span>::<span class="ident">align</span>(          <span class="ident">lbl</span>, <span class="ident">screen</span>, <span class="ident">obj</span>::<span class="ident">LV_ALIGN_CENTER</span>, <span class="number">0</span>, <span class="op">-</span><span class="number">30</span>) <span class="question-mark">?</span> ;    
                <span class="ident">lbl</span>  <span class="comment">//  Return the label as time_label</span>
            },</pre></div>
<p>We're rendering the UI with the <a href="https://docs.lvgl.io/latest/en/html/index.html"><strong>LVGL Library (Version 7)</strong></a>, which we have ported to Mynewt on PineTime as <a href="https://gitlab.com/lupyuen/pinetime_lvgl_mynewt"><code>pinetime_lvgl_mynewt</code></a>.</p>
<p>LVGL is a C Library, so calling the LVGL Library in Rust looks... Different. Check out the article <a href="https://lupyuen.github.io/pinetime-rust-riot/articles/watch_face">&quot;Porting PineTime Watch Face from C to Rust On RIOT with LVGL&quot;</a></p>
<p>The code above creates a <strong>Time Label</strong> for the time and positions the Label at the centre of PineTime's display...</p>
<table><thead><tr><th align="left">LVGL Function</th><th align="left">What it does</th></tr></thead><tbody>
<tr><td align="left"><code>label::set_long_mode</code></td><td align="left">Set the text wrapping for the label</td></tr>
<tr><td align="left"><code>label::set_text</code></td><td align="left">Set the text in the label</td></tr>
<tr><td align="left"><code>obj::set_width</code></td><td align="left">Set the label width (in pixels)</td></tr>
<tr><td align="left"><code>obj::set_height</code></td><td align="left">Set the label height (in pixels)</td></tr>
<tr><td align="left"><code>label::set_align</code></td><td align="left">Set the label text alignment</td></tr>
<tr><td align="left"><code>obj::align</code></td><td align="left">Align the label to the screen</td></tr>
</tbody></table>
<p>Label Widgets in LVGL are documented here: <a href="https://docs.lvgl.io/latest/en/html/widgets/label.html">Label Widget</a></p>
<p>Below the Time Label, we create a <strong>Date Label</strong> for the date...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
            <span class="comment">//  Create a Label for Date: &quot;MON 22 MAY 2020&quot;</span>
            <span class="ident">date_label</span>: {
                <span class="kw">let</span> <span class="ident">lbl</span> <span class="op">=</span> <span class="ident">label</span>::<span class="ident">create</span>(<span class="ident">screen</span>, <span class="ident">ptr</span>::<span class="ident">null</span>()) <span class="question-mark">?</span> ;
                <span class="ident">label</span>::<span class="ident">set_long_mode</span>(<span class="ident">lbl</span>, <span class="ident">label</span>::<span class="ident">LV_LABEL_LONG_BREAK</span>) <span class="question-mark">?</span> ;
                <span class="ident">obj</span>::<span class="ident">set_width</span>(      <span class="ident">lbl</span>, <span class="number">200</span>) <span class="question-mark">?</span> ;
                <span class="ident">obj</span>::<span class="ident">set_height</span>(     <span class="ident">lbl</span>, <span class="number">200</span>) <span class="question-mark">?</span> ;
                <span class="ident">label</span>::<span class="ident">set_text</span>(     <span class="ident">lbl</span>, <span class="macro">strn</span><span class="macro">!</span>(<span class="string">&quot;&quot;</span>)) <span class="question-mark">?</span> ;  <span class="comment">//  strn creates a null-terminated string</span>
                <span class="ident">label</span>::<span class="ident">set_align</span>(    <span class="ident">lbl</span>, <span class="ident">label</span>::<span class="ident">LV_LABEL_ALIGN_CENTER</span>) <span class="question-mark">?</span> ;
                <span class="ident">obj</span>::<span class="ident">align</span>(          <span class="ident">lbl</span>, <span class="ident">screen</span>, <span class="ident">obj</span>::<span class="ident">LV_ALIGN_CENTER</span>, <span class="number">0</span>, <span class="number">40</span>) <span class="question-mark">?</span> ;
                <span class="ident">lbl</span>  <span class="comment">//  Return the label as date_label</span>
            },</pre></div>
<p>At top left we create a <strong>Bluetooth Label</strong> to indicate whether PineTime is connected on Bluetooth LE...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
            <span class="comment">//  Create a Label for Bluetooth State</span>
            <span class="ident">bluetooth_label</span>: {
                <span class="kw">let</span> <span class="ident">lbl</span> <span class="op">=</span> <span class="ident">label</span>::<span class="ident">create</span>(<span class="ident">screen</span>, <span class="ident">ptr</span>::<span class="ident">null</span>()) <span class="question-mark">?</span> ;
                <span class="ident">obj</span>::<span class="ident">set_width</span>(     <span class="ident">lbl</span>, <span class="number">50</span>) <span class="question-mark">?</span> ;
                <span class="ident">obj</span>::<span class="ident">set_height</span>(    <span class="ident">lbl</span>, <span class="number">80</span>) <span class="question-mark">?</span> ;
                <span class="ident">label</span>::<span class="ident">set_text</span>(    <span class="ident">lbl</span>, <span class="macro">strn</span><span class="macro">!</span>(<span class="string">&quot;&quot;</span>)) <span class="question-mark">?</span> ;  <span class="comment">//  strn creates a null-terminated string</span>
                <span class="ident">label</span>::<span class="ident">set_recolor</span>( <span class="ident">lbl</span>, <span class="bool-val">true</span>) <span class="question-mark">?</span> ;
                <span class="ident">label</span>::<span class="ident">set_align</span>(   <span class="ident">lbl</span>, <span class="ident">label</span>::<span class="ident">LV_LABEL_ALIGN_LEFT</span>) <span class="question-mark">?</span> ;
                <span class="ident">obj</span>::<span class="ident">align</span>(         <span class="ident">lbl</span>, <span class="ident">screen</span>, <span class="ident">obj</span>::<span class="ident">LV_ALIGN_IN_TOP_LEFT</span>, <span class="number">0</span>, <span class="number">0</span>) <span class="question-mark">?</span> ;
                <span class="ident">lbl</span>  <span class="comment">//  Return the label as bluetooth_label</span>
            },</pre></div>
<p>At top right we create a <strong>Power Label</strong> to indicate the battery status and whether PineTime is charging...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
            <span class="comment">//  Create a Label for Power Indicator</span>
            <span class="ident">power_label</span>: {
                <span class="kw">let</span> <span class="ident">lbl</span> <span class="op">=</span> <span class="ident">label</span>::<span class="ident">create</span>(<span class="ident">screen</span>, <span class="ident">ptr</span>::<span class="ident">null</span>()) <span class="question-mark">?</span> ;
                <span class="ident">obj</span>::<span class="ident">set_width</span>(    <span class="ident">lbl</span>, <span class="number">80</span>) <span class="question-mark">?</span> ;
                <span class="ident">obj</span>::<span class="ident">set_height</span>(   <span class="ident">lbl</span>, <span class="number">20</span>) <span class="question-mark">?</span> ;
                <span class="ident">label</span>::<span class="ident">set_text</span>(   <span class="ident">lbl</span>, <span class="macro">strn</span><span class="macro">!</span>(<span class="string">&quot;&quot;</span>)) <span class="question-mark">?</span> ;  <span class="comment">//  strn creates a null-terminated string</span>
                <span class="ident">label</span>::<span class="ident">set_recolor</span>(<span class="ident">lbl</span>, <span class="bool-val">true</span>) <span class="question-mark">?</span> ;
                <span class="ident">label</span>::<span class="ident">set_align</span>(  <span class="ident">lbl</span>, <span class="ident">label</span>::<span class="ident">LV_LABEL_ALIGN_RIGHT</span>) <span class="question-mark">?</span> ;
                <span class="ident">obj</span>::<span class="ident">align</span>(        <span class="ident">lbl</span>, <span class="ident">screen</span>, <span class="ident">obj</span>::<span class="ident">LV_ALIGN_IN_TOP_RIGHT</span>, <span class="number">0</span>, <span class="number">0</span>) <span class="question-mark">?</span> ;
                <span class="ident">lbl</span>  <span class="comment">//  Return the label as power_label</span>
            },
        };
        <span class="comment">//  Return the watch face</span>
        <span class="prelude-val">Ok</span>(<span class="ident">watch_face</span>)
    }</pre></div>
<p><em>Why did we call <code>set_recolor</code> for the Bluetooth and Power labels?</em></p>
<p>Instead of the default white colour, we'll be showing the Bluetooth and Power Labels in various colour (to indicate the current status).</p>
<p>By calling <code>set_recolor</code> on the Bluetooth and Power Labels, we may specify <code>#RGB</code> Colour Codes inside the labels. For example, this label...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
#<span class="number">00ff00</span> <span class="ident">OK</span>#</pre></div>
<p>Will show the text <code>OK</code> in Green. We'll see the <code>#RGB</code> Colour Codes in a while.</p>
<p><em>Where are the Labels defined?</em></p>
<p>The Labels are defined in the <code>BarebonesWatchFace</code> Struct in <a href="https://github.com/lupyuen/barebones-watchface/blob/master/src/lib.rs#L55-L65"><code>lib.rs</code></a>...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Barebones Watch Face with no frills</span>
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">BarebonesWatchFace</span> {
    <span class="doccomment">/// Label for Time: &quot;12:34&quot;</span>
    <span class="kw">pub</span> <span class="ident">time_label</span>:      <span class="ident">lvgl</span>::<span class="ident">Ptr</span>,
    <span class="doccomment">/// Label for Date: &quot;MON 22 MAY 2020&quot;</span>
    <span class="kw">pub</span> <span class="ident">date_label</span>:      <span class="ident">lvgl</span>::<span class="ident">Ptr</span>,
    <span class="doccomment">/// Label for Bluetooth State (Bluetooth Icon)</span>
    <span class="kw">pub</span> <span class="ident">bluetooth_label</span>: <span class="ident">lvgl</span>::<span class="ident">Ptr</span>,
    <span class="doccomment">/// Label for Power Indicator (Charging &amp; Battery)</span>
    <span class="kw">pub</span> <span class="ident">power_label</span>:     <span class="ident">lvgl</span>::<span class="ident">Ptr</span>,
}</pre></div>
<h1 id="update-watch-face" class="section-header"><a href="#update-watch-face">2 Update Watch Face</a></h1>
<p>Recall that to roll our Watch Face we need to provide two functions: <code>new</code> (to create the Watch Face) and <code>update</code> (to update our Watch Face).</p>
<p>In the previous section we have done <code>new</code>, now let's do <code>update</code> in <a href="https://github.com/lupyuen/barebones-watchface/blob/master/src/lib.rs#L131-L146"><code>lib.rs</code></a>...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">impl</span> <span class="ident">WatchFace</span> <span class="kw">for</span> <span class="ident">BarebonesWatchFace</span> {

    <span class="doccomment">/// Update the widgets in the Watch Face with the current state</span>
    <span class="kw">fn</span> <span class="ident">update</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">state</span>: <span class="kw-2">&amp;</span><span class="ident">WatchFaceState</span>) <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
        <span class="comment">//  Populate the Time and Date Labels</span>
        <span class="self">self</span>.<span class="ident">update_date_time</span>(<span class="ident">state</span>) <span class="question-mark">?</span> ;

        <span class="comment">//  Populate the Bluetooth Label</span>
        <span class="self">self</span>.<span class="ident">update_bluetooth</span>(<span class="ident">state</span>) <span class="question-mark">?</span> ;

        <span class="comment">//  Populate the Power Label</span>
        <span class="self">self</span>.<span class="ident">update_power</span>(<span class="ident">state</span>) <span class="question-mark">?</span> ;
        <span class="prelude-val">Ok</span>(())
    }    </pre></div>
<p>Every minute the Watch Face Framework calls <code>update</code>, passing a <code>WatchFaceState</code> with the current date, time, Bluetooth status and charging status: <a href="https://github.com/lupyuen/pinetime-watchface/blob/master/src/lib.rs#L211-L224"><code>pinetime-watchface/src/lib.rs</code></a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// State for the Watch Face</span>
<span class="attribute">#[<span class="ident">repr</span>(<span class="ident">C</span>)]</span>  <span class="comment">//  Allow this struct to be passed to C (for WebAssembly integration)</span>
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">WatchFaceState</span> {
    <span class="doccomment">/// Current date and time</span>
    <span class="kw">pub</span> <span class="ident">time</span>:       <span class="ident">WatchFaceTime</span>,
    <span class="doccomment">/// Bluetooth state</span>
    <span class="kw">pub</span> <span class="ident">bluetooth</span>:  <span class="ident">BluetoothState</span>,
    <span class="doccomment">/// Current power</span>
    <span class="kw">pub</span> <span class="ident">millivolts</span>: <span class="ident">u32</span>,
    <span class="doccomment">/// True if watch is charging</span>
    <span class="kw">pub</span> <span class="ident">charging</span>:   <span class="ident">bool</span>,
    <span class="doccomment">/// True if watch is powered</span>
    <span class="kw">pub</span> <span class="ident">powered</span>:    <span class="ident">bool</span>,
}</pre></div>
<p>Let's study how the <code>update_date_time</code>, <code>update_bluetooth</code> and <code>update_power</code> functions refresh the Date, Time, Bluetooth and Power Labels based on the <code>WatchFaceState</code>...</p>
<p><img src="https://lupyuen.github.io/images/timesync-layout.png" alt="Watch Face Layout" /></p>
<p><a href="https://lupyuen.github.io/barebones-watchface/lvgl.html"><strong>Preview this Watch Face in your web browser</strong></a></p>
<h2 id="update-time-label" class="section-header"><a href="#update-time-label">2.1 Update Time Label</a></h2>
<p>Every minute the <code>update</code> function calls <code>update_date_time</code>, passing a <code>WatchFaceState</code> struct.</p>
<p>Inside the <code>WatchFaceState</code> struct is a <a href="https://github.com/lupyuen/pinetime-watchface/blob/master/src/lib.rs#L226-L243"><code>WatchFaceTime</code> struct</a> that contains the current date and time...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Watch Face Time</span>
<span class="attribute">#[<span class="ident">repr</span>(<span class="ident">C</span>)]</span>  <span class="comment">//  Allow this struct to be passed to C (for WebAssembly integration)</span>
<span class="kw">pub</span> <span class="kw">struct</span> <span class="ident">WatchFaceTime</span> {
    <span class="doccomment">///  Year (4 digit year)</span>
    <span class="kw">pub</span> <span class="ident">year</span>:       <span class="ident">u16</span>,  
    <span class="doccomment">///  Month (1 - 12)</span>
    <span class="kw">pub</span> <span class="ident">month</span>:       <span class="ident">u8</span>,  
    <span class="doccomment">///  Day (1 - 31)</span>
    <span class="kw">pub</span> <span class="ident">day</span>:         <span class="ident">u8</span>,  
    <span class="doccomment">///  Hour (0 - 23)</span>
    <span class="kw">pub</span> <span class="ident">hour</span>:        <span class="ident">u8</span>,  
    <span class="doccomment">///  Minute (0 - 59)</span>
    <span class="kw">pub</span> <span class="ident">minute</span>:      <span class="ident">u8</span>,  
    <span class="doccomment">///  Second (0 - 59)</span>
    <span class="kw">pub</span> <span class="ident">second</span>:      <span class="ident">u8</span>,  
    <span class="doccomment">/// Day of week (0 - 6; 0 = Sunday)</span>
    <span class="kw">pub</span> <span class="ident">day_of_week</span>: <span class="ident">u8</span>,  
}</pre></div>
<p>Our function <code>update_date_time</code> refreshes the Time Label like so: <a href="https://github.com/lupyuen/barebones-watchface/blob/master/src/lib.rs#L148-L189"><code>barebones-watchface/src/lib.rs</code></a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">impl</span> <span class="ident">BarebonesWatchFace</span> {

    <span class="doccomment">/// Populate the Time and Date Labels with the time and date</span>
    <span class="kw">fn</span> <span class="ident">update_date_time</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">state</span>: <span class="kw-2">&amp;</span><span class="ident">WatchFaceState</span>) <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
        <span class="comment">//  Format the time as &quot;12:34&quot;</span>
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">buf</span> <span class="op">=</span> <span class="ident">new_string</span>();
        <span class="macro">write</span><span class="macro">!</span>(
            <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">buf</span>,         <span class="comment">//  Write the formatted text here</span>
            <span class="string">&quot;{:02}:{:02}\0&quot;</span>,  <span class="comment">//  Must terminate Rust strings with null</span>
            <span class="ident">state</span>.<span class="ident">time</span>.<span class="ident">hour</span>,
            <span class="ident">state</span>.<span class="ident">time</span>.<span class="ident">minute</span>
        ).<span class="ident">expect</span>(<span class="string">&quot;time fail&quot;</span>);

        <span class="comment">//  Set the label</span>
        <span class="ident">label</span>::<span class="ident">set_text</span>(      
            <span class="self">self</span>.<span class="ident">time_label</span>, 
            <span class="kw-2">&amp;</span><span class="ident">to_strn</span>(<span class="kw-2">&amp;</span><span class="ident">buf</span>)
        ) <span class="question-mark">?</span> ;</pre></div>
<p><em>What's <code>write!</code>?</em></p>
<p><a href="https://doc.rust-lang.org/rust-by-example/hello/print/fmt.html?highlight=write!#formatting"><code>write!</code></a> is a Rust Macro that writes formatted text strings. It works like a safer version of <code>sprintf</code> as explained here: <a href="https://lupyuen.github.io/pinetime-rust-riot/articles/watch_face#heapless-strings-in-rust">&quot;Heapless Strings in Rust&quot;</a></p>
<p><em>What's <code>new_string</code>?</em></p>
<p><code>new_string</code> creates a new <a href="https://docs.rs/heapless/0.5.6/heapless/index.html">Heapless <code>String</code></a> on the stack. Unlike normal the Rust <code>String</code>, our Heapless <code>String</code> doesn't require any Heap Memory and works well on embedded platforms.</p>
<p>Our Watch Face Framework exposes a Heapless <code>String</code> Type that limits strings to 64 characters. Which is sufficient for most Watch Faces (and prevents buffer overflows). This is defined in <a href="https://github.com/lupyuen/pinetime-watchface/blob/master/src/lib.rs#L195-L206"><code>pinetime-watchface/src/lib.rs</code></a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Limit Strings to 64 chars (which may include multiple color codes like &quot;#ffffff&quot;)</span>
<span class="kw">pub</span> <span class="kw">type</span> <span class="ident">String</span> <span class="op">=</span> <span class="ident">heapless</span>::<span class="ident">String</span>::<span class="op">&lt;</span><span class="ident">heapless</span>::<span class="ident">consts</span>::<span class="ident">U64</span><span class="op">&gt;</span>;

<span class="doccomment">/// Create a new String</span>
<span class="kw">pub</span> <span class="kw">const</span> <span class="kw">fn</span> <span class="ident">new_string</span>() <span class="op">-&gt;</span> <span class="ident">String</span> {
    <span class="ident">heapless</span>::<span class="ident">String</span>(<span class="ident">heapless</span>::<span class="ident">i</span>::<span class="ident">String</span>::<span class="ident">new</span>())
}

<span class="doccomment">/// Convert a static String to null-terminated Strn</span>
<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">to_strn</span>(<span class="ident">str</span>: <span class="kw-2">&amp;</span><span class="ident">String</span>) <span class="op">-&gt;</span> <span class="ident">Strn</span> {
    <span class="ident">Strn</span>::<span class="ident">new</span>(<span class="ident">str</span>.<span class="ident">as_bytes</span>())
}</pre></div>
<h2 id="update-date-label" class="section-header"><a href="#update-date-label">2.2 Update Date Label</a></h2>
<p>Our function <code>update_date_time</code> also refreshes the Date Label:  <a href="https://github.com/lupyuen/barebones-watchface/blob/master/src/lib.rs#L148-L189"><code>barebones-watchface/src/lib.rs</code></a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">impl</span> <span class="ident">BarebonesWatchFace</span> {

    <span class="doccomment">/// Populate the Time and Date Labels with the time and date</span>
    <span class="kw">fn</span> <span class="ident">update_date_time</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">state</span>: <span class="kw-2">&amp;</span><span class="ident">WatchFaceState</span>) <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
        <span class="comment">//  Omitted: Format and set the time label</span>
        ...

        <span class="comment">//  Get the short day name (&quot;MON&quot;) and short month name (&quot;MAY&quot;)</span>
        <span class="kw">let</span> <span class="ident">day</span>   <span class="op">=</span> <span class="ident">get_day_name</span>(<span class="kw-2">&amp;</span><span class="ident">state</span>.<span class="ident">time</span>);
        <span class="kw">let</span> <span class="ident">month</span> <span class="op">=</span> <span class="ident">get_month_name</span>(<span class="kw-2">&amp;</span><span class="ident">state</span>.<span class="ident">time</span>);

        <span class="comment">//  Format the date as &quot;MON 22 MAY 2020&quot;</span>
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">buf</span> <span class="op">=</span> <span class="ident">new_string</span>();
        <span class="macro">write</span><span class="macro">!</span>(
            <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">buf</span>,           <span class="comment">//  Write the formatted text here</span>
            <span class="string">&quot;{} {} {} {}\n\0&quot;</span>,  <span class="comment">//  Must terminate Rust strings with null</span>
            <span class="ident">day</span>,
            <span class="ident">state</span>.<span class="ident">time</span>.<span class="ident">day</span>,
            <span class="ident">month</span>,
            <span class="ident">state</span>.<span class="ident">time</span>.<span class="ident">year</span>
        ).<span class="ident">expect</span>(<span class="string">&quot;date fail&quot;</span>);

        <span class="comment">//  Set the label</span>
        <span class="ident">label</span>::<span class="ident">set_text</span>(
            <span class="self">self</span>.<span class="ident">date_label</span>, 
            <span class="kw-2">&amp;</span><span class="ident">to_strn</span>(<span class="kw-2">&amp;</span><span class="ident">buf</span>)
        ) <span class="question-mark">?</span> ;
        <span class="prelude-val">Ok</span>(())
    }    </pre></div>
<p><code>get_month_name</code> converts a numeric month (1 to 12) to text (like <code>JAN</code>): <a href="https://github.com/lupyuen/barebones-watchface/blob/master/src/lib.rs#L270-L289"><code>lib.rs</code></a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Get month short name</span>
<span class="kw">fn</span> <span class="ident">get_month_name</span>(<span class="ident">time</span>: <span class="kw-2">&amp;</span><span class="ident">WatchFaceTime</span>) <span class="op">-&gt;</span> <span class="ident">String</span> {
    <span class="ident">String</span>::<span class="ident">from</span>(
        <span class="kw">match</span> <span class="ident">time</span>.<span class="ident">month</span> {
            <span class="number">1</span>  <span class="op">=&gt;</span> <span class="string">&quot;JAN&quot;</span>,
            <span class="number">2</span>  <span class="op">=&gt;</span> <span class="string">&quot;FEB&quot;</span>,
            <span class="number">3</span>  <span class="op">=&gt;</span> <span class="string">&quot;MAR&quot;</span>,
            ...</pre></div>
<p><code>get_day_name</code> converts a numeric day-of-week (0 to 6) to text (like <code>SUN</code>): <a href="https://github.com/lupyuen/barebones-watchface/blob/master/src/lib.rs#L291-L305"><code>lib.rs</code></a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Get day short name</span>
<span class="kw">fn</span> <span class="ident">get_day_name</span>(<span class="ident">time</span>: <span class="op">&amp;</span> <span class="ident">WatchFaceTime</span>) <span class="op">-&gt;</span> <span class="ident">String</span> {
    <span class="ident">String</span>::<span class="ident">from</span>(
        <span class="kw">match</span> <span class="ident">time</span>.<span class="ident">day_of_week</span> {
            <span class="number">0</span>  <span class="op">=&gt;</span> <span class="string">&quot;SUN&quot;</span>,
            <span class="number">1</span>  <span class="op">=&gt;</span> <span class="string">&quot;MON&quot;</span>,
            <span class="number">2</span>  <span class="op">=&gt;</span> <span class="string">&quot;TUE&quot;</span>,
            ...</pre></div>
<h2 id="update-bluetooth-label" class="section-header"><a href="#update-bluetooth-label">2.3 Update Bluetooth Label</a></h2>
<p>Our function <code>update_bluetooth</code> refreshes the Bluetooth Label like so: <a href="https://github.com/lupyuen/barebones-watchface/blob/master/src/lib.rs#L191-L223"><code>barebones-watchface/src/lib.rs</code></a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">impl</span> <span class="ident">BarebonesWatchFace</span> {

    <span class="doccomment">/// Populate the Bluetooth Label with the Bluetooth State (Bluetooth Icon)</span>
    <span class="kw">fn</span> <span class="ident">update_bluetooth</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">state</span>: <span class="kw-2">&amp;</span><span class="ident">WatchFaceState</span>) <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
        <span class="kw">if</span> <span class="ident">state</span>.<span class="ident">bluetooth</span> <span class="op">==</span> <span class="ident">BluetoothState</span>::<span class="ident">BLUETOOTH_STATE_DISCONNECTED</span> {
            <span class="comment">//  If Bluetooth is disconnected, leave the label empty</span>
            <span class="ident">label</span>::<span class="ident">set_text</span>(
                <span class="self">self</span>.<span class="ident">bluetooth_label</span>, 
                <span class="macro">strn</span><span class="macro">!</span>(<span class="string">&quot;&quot;</span>)
            ) <span class="question-mark">?</span> ;
        } <span class="kw">else</span> {
            <span class="comment">//  Compute the color of the Bluetooth icon</span>
            <span class="kw">let</span> <span class="ident">color</span> <span class="op">=</span> 
                <span class="kw">match</span> <span class="kw-2">&amp;</span><span class="ident">state</span>.<span class="ident">bluetooth</span> {
                    <span class="ident">BluetoothState</span>::<span class="ident">BLUETOOTH_STATE_INACTIVE</span>     <span class="op">=&gt;</span> <span class="string">&quot;#000000&quot;</span>,  <span class="comment">//  Black</span>
                    <span class="ident">BluetoothState</span>::<span class="ident">BLUETOOTH_STATE_ADVERTISING</span>  <span class="op">=&gt;</span> <span class="string">&quot;#0000ff&quot;</span>,  <span class="comment">//  Blue</span>
                    <span class="ident">BluetoothState</span>::<span class="ident">BLUETOOTH_STATE_DISCONNECTED</span> <span class="op">=&gt;</span> <span class="string">&quot;#ff0000&quot;</span>,  <span class="comment">//  Red</span>
                    <span class="ident">BluetoothState</span>::<span class="ident">BLUETOOTH_STATE_CONNECTED</span>    <span class="op">=&gt;</span> <span class="string">&quot;#00ff00&quot;</span>,  <span class="comment">//  Green</span>
                };

            <span class="comment">//  Format the Bluetooth status</span>
            <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">buf</span> <span class="op">=</span> <span class="ident">new_string</span>();
            <span class="macro">write</span><span class="macro">!</span>(
                <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">buf</span>,              <span class="comment">//  Write the formatted text here</span>
                <span class="string">&quot;{} \u{F293}#\0&quot;</span>,      <span class="comment">//  LV_SYMBOL_BLUETOOTH. Must terminate Rust strings with null.</span>
                <span class="ident">color</span>
            ).<span class="ident">expect</span>(<span class="string">&quot;bt fail&quot;</span>);

            <span class="comment">//  Set the label</span>
            <span class="ident">label</span>::<span class="ident">set_text</span>(
                <span class="self">self</span>.<span class="ident">bluetooth_label</span>, 
                <span class="kw-2">&amp;</span><span class="ident">to_strn</span>(<span class="kw-2">&amp;</span><span class="ident">buf</span>)
            ) <span class="question-mark">?</span> ;
        }
        <span class="prelude-val">Ok</span>(())
    }</pre></div>
<p><em>What does this do?</em></p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="comment">//  Compute the color of the Bluetooth icon</span>
<span class="kw">let</span> <span class="ident">color</span> <span class="op">=</span> 
    <span class="kw">match</span> <span class="kw-2">&amp;</span><span class="ident">state</span>.<span class="ident">bluetooth</span> {
        <span class="ident">BluetoothState</span>::<span class="ident">BLUETOOTH_STATE_INACTIVE</span>     <span class="op">=&gt;</span> <span class="string">&quot;#000000&quot;</span>,  <span class="comment">//  Black</span>
        <span class="ident">BluetoothState</span>::<span class="ident">BLUETOOTH_STATE_ADVERTISING</span>  <span class="op">=&gt;</span> <span class="string">&quot;#0000ff&quot;</span>,  <span class="comment">//  Blue</span>
        <span class="ident">BluetoothState</span>::<span class="ident">BLUETOOTH_STATE_DISCONNECTED</span> <span class="op">=&gt;</span> <span class="string">&quot;#ff0000&quot;</span>,  <span class="comment">//  Red</span>
        <span class="ident">BluetoothState</span>::<span class="ident">BLUETOOTH_STATE_CONNECTED</span>    <span class="op">=&gt;</span> <span class="string">&quot;#00ff00&quot;</span>,  <span class="comment">//  Green</span>
    };</pre></div>
<p>This code converts the current Bluetooth State into an <code>#RGB</code> Colour Code <code>color</code>.</p>
<p>The Bluetooth Label is coloured by the <code>#RGB</code> Colour Code. For example, this label...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
#<span class="number">00ff00</span> <span class="ident">OK</span>#</pre></div>
<p>Will show the text <code>OK</code> in Green.</p>
<p><em>What's <code>\u{F293}</code>?</em></p>
<p><code>\u{F293}</code> is the Unicode Symbol for the Bluetooth Icon. So when we set a label to...</p>

<pre><code>#00ff00 \u{F293}#</code></pre>
<p>This means we're displaying the Bluetooth Icon in Green.</p>
<h2 id="update-power-label" class="section-header"><a href="#update-power-label">2.4 Update Power Label</a></h2>
<p>Lastly our function <code>update_power</code> refreshes the Power Label like so: <a href="https://github.com/lupyuen/barebones-watchface/blob/master/src/lib.rs#L225-L265"><code>barebones-watchface/src/lib.rs</code></a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">impl</span> <span class="ident">BarebonesWatchFace</span> {

    <span class="doccomment">/// Populate the Power Label with the Power Indicator (Charging &amp; Battery)</span>
    <span class="kw">fn</span> <span class="ident">update_power</span>(<span class="kw-2">&amp;</span><span class="self">self</span>, <span class="ident">state</span>: <span class="kw-2">&amp;</span><span class="ident">WatchFaceState</span>) <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
        <span class="comment">//  Get the active screen</span>
        <span class="kw">let</span> <span class="ident">screen</span> <span class="op">=</span> <span class="ident">watchface</span>::<span class="ident">get_active_screen</span>();

        <span class="comment">//  Compute the percentage power</span>
        <span class="kw">let</span> <span class="ident">percentage</span> <span class="op">=</span> <span class="ident">convert_battery_voltage</span>(<span class="ident">state</span>.<span class="ident">millivolts</span>);

        <span class="comment">//  Compute the colour for the charging symbol</span>
        <span class="kw">let</span> <span class="ident">color</span> <span class="op">=</span>                                                     <span class="comment">//  Charging color</span>
            <span class="kw">if</span> <span class="ident">percentage</span> <span class="op">&lt;=</span> <span class="number">20</span>                        { <span class="string">&quot;#f2495c&quot;</span> }    <span class="comment">//  Low Battery</span>
            <span class="kw">else</span> <span class="kw">if</span> <span class="ident">state</span>.<span class="ident">powered</span> <span class="op">&amp;&amp;</span> <span class="op">!</span>(<span class="ident">state</span>.<span class="ident">charging</span>) { <span class="string">&quot;#73bf69&quot;</span> }    <span class="comment">//  Full Battery</span>
            <span class="kw">else</span>                                       { <span class="string">&quot;#fade2a&quot;</span> };   <span class="comment">//  Mid Battery</span>

        <span class="kw">let</span> <span class="ident">symbol</span> <span class="op">=</span>                         <span class="comment">//  Charging symbol</span>
            <span class="kw">if</span> <span class="ident">state</span>.<span class="ident">powered</span> { <span class="string">&quot;\u{F0E7}&quot;</span> }  <span class="comment">//  LV_SYMBOL_CHARGE</span>
            <span class="kw">else</span>             { <span class="string">&quot; &quot;</span> };

        <span class="comment">//  Format the Power Indicator</span>
        <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">buf</span> <span class="op">=</span> <span class="ident">new_string</span>();
        <span class="macro">write</span><span class="macro">!</span>(
            <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">buf</span>,                    <span class="comment">//  Write the formatted text here</span>
            <span class="string">&quot;{} {}%{}#\nRUST ({}mV)\0&quot;</span>,  <span class="comment">//  Must terminate Rust strings with null</span>
            <span class="ident">color</span>,
            <span class="ident">percentage</span>,
            <span class="ident">symbol</span>,
            <span class="ident">state</span>.<span class="ident">millivolts</span>
        ).<span class="ident">expect</span>(<span class="string">&quot;batt fail&quot;</span>);

        <span class="comment">//  Set the label</span>
        <span class="ident">label</span>::<span class="ident">set_text</span>(
            <span class="self">self</span>.<span class="ident">power_label</span>, 
            <span class="kw-2">&amp;</span><span class="ident">to_strn</span>(<span class="kw-2">&amp;</span><span class="ident">buf</span>)
        ) <span class="question-mark">?</span> ; 

        <span class="comment">//  Align the label to the top right of the screen</span>
        <span class="ident">obj</span>::<span class="ident">align</span>(
            <span class="self">self</span>.<span class="ident">power_label</span>, <span class="ident">screen</span>, 
            <span class="ident">obj</span>::<span class="ident">LV_ALIGN_IN_TOP_RIGHT</span>, <span class="number">0</span>, <span class="number">0</span>
        ) <span class="question-mark">?</span> ;
        <span class="prelude-val">Ok</span>(())
    }</pre></div>
<p><code>\u{F0E7}</code> is the Unicode Symbol for the Charging Icon.</p>
<p>See the <code>RUST</code> text above?</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="comment">//  Format the Power Indicator</span>
<span class="macro">write</span><span class="macro">!</span>(
    <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">buf</span>,                    <span class="comment">//  Write the formatted text here</span>
    <span class="string">&quot;{} {}%{}#\nRUST ({}mV)\0&quot;</span>,  <span class="comment">//  Must terminate Rust strings with null</span></pre></div>
<p>In a while we'll change <code>RUST</code> to create our Custom Watch Face.</p>
<p>To learn more about the Watch Face Framework and the Rust Wrappers for LVGL and Mynewt (and the helper macros)...</p>
<ul>
<li>
<p><a href="https://docs.rs/pinetime-watchface">Documentation for <code>pinetime-watchface</code></a></p>
</li>
<li>
<p><a href="https://docs.rs/pinetime-lvgl">Documentation for <code>pinetime-lvgl</code></a></p>
</li>
<li>
<p><a href="https://docs.rs/pinetime-mynewt">Documentation for <code>pinetime-mynewt</code></a></p>
</li>
<li>
<p><a href="https://docs.rs/pinetime-macros">Documentation for <code>pinetime-macros</code></a></p>
</li>
</ul>
<p>Now that we understand Rust Watch Faces, let's publish our own Watch Face on crates.io...</p>
<p><img src="https://lupyuen.github.io/images/timesync-crate.jpg" alt="Discovering Watch Faces at crates.io" /></p>
<h1 id="discover-watch-faces-and-publish-your-own" class="section-header"><a href="#discover-watch-faces-and-publish-your-own">3 Discover Watch Faces and Publish Your Own</a></h1>
<p><em>How can we discover PineTime Watch Faces that others have created?</em></p>
<p><em>So that we may load them into our watches... Even modify them?</em></p>
<p>It's easy to discover Rust Watch Faces for PineTime! Just head over to <a href="https://crates.io"><strong>crates.io</strong></a> and search for...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">pinetime</span> <span class="ident">watchface</span></pre></div>
<p><a href="https://crates.io/search?q=pinetime%20watchface&amp;sort=recent-updates">Search crates.io for <code>pinetime watchface</code></a></p>
<p>Each Watch Face comes with its own link to let us preview the Watch Face in our web browser (thanks to WebAssembly)</p>
<p><a href="https://lupyuen.github.io/barebones-watchface/lvgl.html">Click here to preview Barebones Watch Face</a></p>
<p><img src="https://lupyuen.github.io/images/timesync-simulator.jpg" alt="Watch Face Simulator" /></p>
<p><em>How do we publish our own Watch Face?</em></p>
<ol>
<li>
<p>Browse to the Barebones Watch Face repo: <a href="https://github.com/lupyuen/barebones-watchface"><code>github.com/lupyuen/barebones-watchface</code></a></p>
<p>Click <code>Forks</code>  <code>Fork</code> to create your own Fork of Barebones Watch Face.</p>
<p>Click <code>Settings</code></p>
<p><img src="https://lupyuen.github.io/images/timesync-publish1.jpg" alt="Publish Watch Face Step 1" /></p>
</li>
<li>
<p>Scroll down the <code>Settings</code> page and look for <code>GitHub Pages</code></p>
<p>Select <code>Master</code> and <code>/docs</code>. Click <code>Save</code></p>
<p>Click <code>Actions</code>  <code>I Understand My Workflows Enable Them</code></p>
<p><img src="https://lupyuen.github.io/images/timesync-publish2.jpg" alt="Publish Watch Face Step 2" /></p>
</li>
<li>
<p>Click <code>Code</code>  <code>View Code</code>  <code>src</code>  <code>lib.rs</code></p>
<p><img src="https://lupyuen.github.io/images/timesync-publish3.jpg" alt="Publish Watch Face Step 3" /></p>
</li>
<li>
<p>Click the <code>Edit</code> icon. Look for the function <code>update_power</code></p>
<p>Change the <code>RUST</code> text to your own message, like <code>LOVE</code></p>
<p>Click <code>Commit Changes</code></p>
<p><img src="https://lupyuen.github.io/images/timesync-publish4.jpg" alt="Publish Watch Face Step 4" /></p>
</li>
<li>
<p>Click <code>Actions</code>  <code>Update lib.rs</code>  <code>build</code></p>
<p>Wait about 6 minutes for GitHub Actions to build your Watch Face.</p>
<p>Subsequent builds will complete faster, in around 2 minutes (because of the cached dependencies)</p>
<p><img src="https://lupyuen.github.io/images/timesync-publish5.jpg" alt="Publish Watch Face Step 5" /></p>
</li>
<li>
<p>Browse to your Watch Face at...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">https</span>:<span class="comment">//YOUR_GITHUB_ACCOUNT.github.io/barebones-watchface</span></pre></div>
<p>Change <code>YOUR_GITHUB_ACCOUNT</code> to your GitHub Account Name.</p>
<p>Click <code>PineTime Watch Face Simulator</code> and your Custom Watch Face appears (rendered with WebAssembly)...</p>
<p><img src="https://lupyuen.github.io/images/timesync-publish6.jpg" alt="Publish Watch Face Step 6" /></p>
</li>
<li>
<p>Your Custom Watch Face can now be built and installed by other PineTime Owners! Just share with them your Watch Face repo URL...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">https</span>:<span class="comment">//github.com/YOUR_GITHUB_ACCOUNT/barebones-watchface</span></pre></div>
<p>Change <code>YOUR_GITHUB_ACCOUNT</code> to your GitHub Account Name.</p>
<p>You should probably rename <code>barebone-watchface</code>... Just click <code>Settings</code> to rename your repo.</p>
<p>Remember to edit <a href="https://github.com/lupyuen/barebones-watchface/blob/master/README.md"><code>README.md</code></a> and change the preview URL...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
[<span class="ident">__Preview</span> <span class="ident">this</span> <span class="ident">Watch</span> <span class="ident">Face</span> <span class="kw">in</span> <span class="ident">your</span> <span class="ident">web</span> <span class="ident">browser__</span>](<span class="ident">https</span>:<span class="comment">//lupyuen.github.io/barebones-watchface/lvgl.html)</span></pre></div>
</li>
</ol>
<p>But most PineTime Owners won't know that your Watch Face exists... That's why we upload our Watch Faces to crates.io as a Central Registry of all Rust Watch Faces for PineTime.</p>
<p><em>How do we upload our Custom Watch Face to crates.io?</em></p>
<p>Follow the instructions here: <a href="https://doc.rust-lang.org/cargo/reference/publishing.html">&quot;Publishing on crates.io&quot;</a></p>
<p>Update the fields in <a href="https://github.com/lupyuen/barebones-watchface/blob/master/Cargo.toml"><code>Cargo.toml</code></a> to describe your Watch Face...</p>
<pre><code class="language-yaml">[package]
name          = &quot;barebones-watchface&quot;
version       = &quot;1.0.5&quot;
authors       = [&quot;Lee Lup Yuen &lt;luppy@appkaki.com&gt;&quot;]
edition       = &quot;2018&quot;
description   = &quot;Barebones Watch Face for Mynewt on PineTime Smart Watch&quot;
repository    = &quot;https://github.com/lupyuen/barebones-watchface&quot;
documentation = &quot;https://docs.rs/barebones-watchface&quot;
categories    = [&quot;embedded&quot;, &quot;no-std&quot;]
keywords      = [&quot;pinetime&quot;, &quot;watchface&quot;, &quot;mynewt&quot;, &quot;lvgl&quot;, &quot;barebones&quot;]
readme        = &quot;./README.md&quot;
license       = &quot;Apache-2.0&quot;
</code></pre>
<p>Always keep <code>pinetime</code> and <code>watchface</code> in the <code>keywords</code> so that your Watch Face will appear when PineTime Owners search for <code>pinetime watchface</code> on crates.io.</p>
<p>The Documentation URL <code>docs.rs/YOUR_WATCH_FACE</code> will be automatically generated when we have published our Watch Face to crates.io.</p>
<p><a href="https://docs.rs/barebones-watchface">Check out the <code>docs.rs</code> documentation for Barebones Watchface</a></p>
<h1 id="build-and-flash-mynewt-firmware" class="section-header"><a href="#build-and-flash-mynewt-firmware">4 Build and Flash Mynewt Firmware</a></h1>
<p><em>How do we install our Custom Watch Face on a real PineTime watch?</em></p>
<p>We need to build the <a href="https://github.com/lupyuen/pinetime-rust-mynewt"><strong><code>pinetime-rust-mynewt</code></strong></a> firmware... Then flash the firmware to PineTime. </p>
<p>If you don't have a PineTime, try flashing and testing on <a href="https://github.com/lupyuen/remote-pinetime-bot/blob/master/README.md"><strong>Remote PineTime</strong></a> instead. Remote PineTime is a real PineTime watch that's connected 24x7 to the internet... For anyone to flash and test firmware from anywhere in the world.</p>
<p>Choose one of the following ways to build the firmware...</p>
<ol>
<li>
<p><strong>GitHub Actions</strong> (in the GitHub Cloud, no software installation needed)</p>
</li>
<li>
<p><strong>GitLab CI</strong> (in the GitLab Cloud, no software installation needed)</p>
</li>
<li>
<p><strong>Linux</strong> (including PineBook Pro and Raspberry Pi)</p>
</li>
<li>
<p><strong>macOS</strong></p>
</li>
<li>
<p><strong>Windows</strong> (plain old CMD, without MinGW or WSL)</p>
</li>
</ol>
<p>Here are the instructions for building the firmware...</p>
<h2 id="github-actions" class="section-header"><a href="#github-actions">4.1 GitHub Actions</a></h2>
<ol>
<li>
<p>Fork the GitHub Repo: <a href="https://github.com/lupyuen/pinetime-rust-mynewt"><code>github.com/lupyuen/pinetime-rust-mynewt</code></a></p>
</li>
<li>
<p>Click <code>Actions</code>  <code>I Understand My Workflows Enable Them</code></p>
</li>
<li>
<p>Edit <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/rust/app/Cargo.toml"><code>rust/app/Cargo.toml</code></a> and <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/rust/app/src/lib.rs"><code>rust/app/src/lib.rs</code></a> to select the Watch Face (see below)</p>
</li>
<li>
<p>This will trigger the firmware build. Click <code>Actions</code> to download the built firmware Artifact <code>my_sensor_app.img</code></p>
</li>
<li>
<p>GitHub Actions Workflow is at <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/.github/workflows/main.yml"><code>.github/workflows/main.yml</code></a></p>
</li>
</ol>
<h2 id="gitlab-ci" class="section-header"><a href="#gitlab-ci">4.2 GitLab CI</a></h2>
<ol>
<li>
<p>Fork the GitLab Repo: <a href="https://gitlab.com/lupyuen/pinetime-rust-mynewt"><code>gitlab.com/lupyuen/pinetime-rust-mynewt</code></a></p>
</li>
<li>
<p>Enable GitLab CI for the forked repo</p>
</li>
<li>
<p>Edit <a href="https://gitlab.com/lupyuen/pinetime-rust-mynewt/-/blob/master/rust/app/Cargo.toml"><code>rust/app/Cargo.toml</code></a> and <a href="https://gitlab.com/lupyuen/pinetime-rust-mynewt/-/blob/master/rust/app/src/lib.rs"><code>rust/app/src/lib.rs</code></a> to select the Watch Face (see below)</p>
</li>
<li>
<p>This will trigger the firmware build. Click <code>CI / CD</code> to download the built firmware Artifact <code>my_sensor_app.img</code></p>
</li>
<li>
<p>GitLab CI Workflow is at <a href="https://gitlab.com/lupyuen/pinetime-rust-mynewt/-/blob/master/.gitlab-ci.yml"><code>.gitlab-ci.yml</code></a></p>
</li>
</ol>
<h2 id="linux-macos-and-windows" class="section-header"><a href="#linux-macos-and-windows">4.3 Linux, macOS and Windows</a></h2>
<p>Follow the steps under <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/README.md#build-instructions">&quot;Build Instructions&quot;</a>...</p>
<ol>
<li>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/README.md#install-build-tools">&quot;Install Build Tools&quot;</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/README.md#download-source-files">&quot;Download Source Files&quot;</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/README.md#build-application-firmware">&quot;Build Application Firmware&quot;</a></p>
</li>
</ol>
<p>We'll flash this built firmware file in the next step...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">bin</span><span class="op">/</span><span class="ident">targets</span><span class="op">/</span><span class="ident">nrf52_my_sensor</span><span class="op">/</span><span class="ident">app</span><span class="op">/</span><span class="ident">apps</span><span class="op">/</span><span class="ident">my_sensor_app</span><span class="op">/</span><span class="ident">my_sensor_app</span>.<span class="ident">img</span></pre></div>
<h2 id="flash-firmware-to-pinetime" class="section-header"><a href="#flash-firmware-to-pinetime">4.4 Flash Firmware to PineTime</a></h2>
<p>We'll flash the firmware the wired way using an ST-Link v2 or Raspberry Pi.  (We don't recommend flashing by Bluetooth... The firmware is not fully tested and may brick our watch)</p>
<p><strong>For macOS and Linux...</strong></p>
<ol>
<li>
<p>Download and run <a href="https://github.com/lupyuen/pinetime-updater/blob/master/README.md"><strong>PineTime Updater</strong></a>. Connect ST-Link v2 or Raspberry Pi according to the instructions provided.</p>
</li>
<li>
<p>Select <code>Latest Bootloader</code>. The bootloader only needs to be flashed once.</p>
</li>
<li>
<p>PineTime Updater exits after flashing the bootloader. Start PineTime Updater again.</p>
</li>
<li>
<p>Select <code>Downloaded File</code></p>
</li>
<li>
<p>Enter the downloaded path of <code>my_sensor_app.img</code></p>
</li>
<li>
<p>Enter <code>0x8000</code> as the address</p>
</li>
<li>
<p>After flashing, PineTime starts running our firmware</p>
</li>
</ol>
<p><strong>For Windows...</strong></p>
<p>Follow the steps under <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/README.md#build-instructions">&quot;Build Instructions&quot;</a>...</p>
<ol>
<li>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/README.md#build-mcuboot-bootloader">&quot;Build MCUBoot Bootloader&quot;</a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/README.md#flash-mcuboot-bootloader">&quot;Flash MCUBoot Bootloader&quot;</a>. The bootloader only needs to be built and flashed once.</p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/README.md#flash-application-firmware">&quot;Flash Application Firmware&quot;</a></p>
</li>
</ol>
<p><strong>For Remote PineTime...</strong></p>
<p>Upload the built firmware file <code>my_sensor_app.img</code> as a GitHub Release and flash to Remote PineTime...</p>
<ol>
<li>
<p>In you GitHub repo, click <code>Releases</code></p>
</li>
<li>
<p>Click <code>Draft A New Release</code></p>
</li>
<li>
<p>Fill in the <code>Tag Version</code> and <code>Release Title</code></p>
</li>
<li>
<p>Attach the firmware file <code>my_sensor_app.img</code></p>
</li>
<li>
<p>Click <code>Publish Release</code></p>
</li>
<li>
<p>Under <code>Assets</code>, copy the URL of the firmware file <code>my_sensor_app.img</code></p>
</li>
<li>
<p>Follow the steps here to flash the MCUBoot Bootloader and our firmware URL to Remote PineTime...</p>
<p><a href="https://github.com/lupyuen/remote-pinetime-bot/blob/master/README.md">Remote PineTime</a></p>
</li>
</ol>
<h2 id="specify-the-watch-face" class="section-header"><a href="#specify-the-watch-face">4.5 Specify the Watch Face</a></h2>
<p>To specify the Watch Face for the firmware...</p>
<ol>
<li>
<p>Edit <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/rust/app/Cargo.toml"><code>rust/app/Cargo.toml</code></a></p>
</li>
<li>
<p>Look for the <code>barebones-watchface</code> dependency..</p>
<pre><code class="language-yaml"># External Rust libraries used by this module
[dependencies]
...
barebones-watchface = &quot;1.0.5&quot;
</code></pre>
</li>
<li>
<p>Replace the entire line with the Watch Face name and version found on crates.io...</p>
<pre><code class="language-yaml">my-watchface = &quot;1.0.5&quot;
</code></pre>
<p>If the Watch Face isn't published on crates.io, specify the Git URL like so...</p>
<pre><code class="language-yaml">my-watchface = { git = &quot;https://github.com/lupyuen/my-watchface&quot; }
</code></pre>
</li>
<li>
<p>Edit <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/rust/app/src/lib.rs"><code>rust/app/src/lib.rs</code></a></p>
</li>
<li>
<p>Look for <code>WatchFaceType</code>...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Declare the Watch Face Type</span>
<span class="kw">type</span> <span class="ident">WatchFaceType</span> <span class="op">=</span> <span class="ident">barebones_watchface</span>::<span class="ident">BarebonesWatchFace</span>;</pre></div>
</li>
<li>
<p>Change <code>barebones_watchface</code> to the Watch Face Crate Name (replace all <code>-</code> by <code>_</code>).</p>
<p>Change <code>BarebonesWatchFace</code> to the Watch Face Type Name (from <code>README.md</code> or <code>docs.rs</code> documentation).</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">type</span> <span class="ident">WatchFaceType</span> <span class="op">=</span> <span class="ident">my_watchface</span>::<span class="ident">MyWatchFace</span>;</pre></div>
</li>
<li>
<p>Rebuild the firmware and flash to PineTime</p>
</li>
</ol>
<h1 id="whats-next" class="section-header"><a href="#whats-next">5 What's Next</a></h1>
<p><code>pinetime-rust-mynewt</code> was created as a Learning Tool to help us understand what happens inside the firmware of a smartwatch like PineTime.</p>
<p>Today <code>pinetime-rust-mynewt</code> has evolved to make smartwatch programming even easier to learn...</p>
<ol>
<li>
<p>Safe and sensible embedded programming with Rust, <a href="https://youtu.be/LvfCSnOM1Hs">without the traps</a></p>
</li>
<li>
<p>Easier to share, learn and validate small, meaningful chunks of PineTime code... By publishing Watch Faces on crates.io. </p>
<p><em>(No more digging into a HUGE repository of firmware code!)</em></p>
</li>
<li>
<p>Lets us code PineTime firmware on any computer: Linux, macOS and Windows. Even code on a mobile phone... And build in the Cloud with GitHub Actions and GitLab CI. </p>
<p><em>(No more toolchain worries!)</em></p>
</li>
<li>
<p>Standardised on LVGL, the UI toolkit adopted by most PineTime firmware. So any skills we learn on <code>pinetime-rust-mynewt</code> may be easily transferred to other PineTime platforms.</p>
<p><em>(Which means <code>druid</code>, <code>piet</code> and <code>kurbo</code> have been purged from the firmware... But <code>druid</code> may be revived someday as <a href="https://github.com/AppKaki/druid-lvgl"><code>druid-lvgl</code></a>)</em></p>
</li>
</ol>
<h2 id="whos-driving" class="section-header"><a href="#whos-driving">5.1 Who's Driving?</a></h2>
<p>The PineTime Community has been super enthusiastic about turning PineTime into a <strong>&quot;Daily Driver&quot;</strong>... But shouldn't we also understand what's inside our &quot;Daily Driver&quot;?</p>
<p>Maybe make some firmware tweaks and practise some &quot;Driving&quot; ourselves? And understand the firmware code before copying it and letting it &quot;Drive&quot; our lives?</p>
<p>That might be the better way to sustain Open Source development on PineTime. Because if we don't have any PineTime Learners... <em>The &quot;Driving&quot; shall one day come to a halt.</em> :-(</p>
<h2 id="driving-education" class="section-header"><a href="#driving-education">5.2 Driving Education</a></h2>
<p><code>pinetime-rust-mynewt</code> is the school for <strong>&quot;Driver's Ed&quot;</strong>. The firmware has been deconstructed into manageable chunks that are simpler to learn.  And we use Rust wherever posssible... Because <a href="https://youtu.be/LvfCSnOM1Hs">C Pointer Problems can disrupt our learning</a>.</p>
<p>Perhaps one day <code>pinetime-rust-mynewt</code> will become a Daily Driver. But let's take time to enrich our firmware the <strong>Educational Way,</strong> so that everyone can learn...</p>
<ol>
<li>
<p>Integrate the <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/rust/app/src/touch_sensor.rs"><strong>Touch Controller Driver</strong></a> in Rust with LVGL (to support touch input)</p>
</li>
<li>
<p>Add Rust Drivers for <strong>Step Counting</strong> and <strong>Heart Rate Sensing</strong></p>
</li>
<li>
<p>Improve the <strong>Power Efficiency</strong> of the firmware (like switching off the backlight when idle)</p>
</li>
<li>
<p>Allow <strong>Watch Apps</strong> to published on crates.io, for building Custom PineTime Firmware in the Cloud (see the sketch below)</p>
</li>
<li>
<p>Fill in the missing Rust Bindings for Watch Faces, LVGL and Mynewt: <a href="https://docs.rs/pinetime-watchface"><code>pinetime-watchface</code></a>, <a href="https://docs.rs/pinetime-lvgl"><code>pinetime-lvgl</code></a>, <a href="https://docs.rs/pinetime-mynewt"><code>pinetime-mynewt</code></a></p>
</li>
</ol>
<p>Lemme know if you're keen to help! :-)</p>
<p>In the meantime, please go right ahead to create your own Watch Faces and publish them on crates.io... So that all PineTime Owners can share, learn and enjoy :-)</p>
<p><a href="https://lupyuen.github.io">Check out my PineTime articles</a></p>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here...</em></p>
<p><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/rust/app/src/watchface.md"><code>github.com/lupyuen/pinetime-rust-mynewt/rust/app/src/watchface.md</code></a></p>
<p><img src="https://lupyuen.github.io/images/cloud-firmware.jpg" alt="Custom PineTime Firmware Built In The Cloud" /></p>
<h1 id="advanced-topic-webassembly-simulator" class="section-header"><a href="#advanced-topic-webassembly-simulator">6 Advanced Topic: WebAssembly Simulator</a></h1>
<p>The WebAssembly Simulator for Watch Faces is auto-generated by a GitHub Actions Workflow: <a href=".github/workflows/simulator.yml"><code>simulator.yml</code></a></p>
<p>Source code for the WebAssembly Simulator is at the <a href="https://github.com/AppKaki/lvgl-wasm/tree/mynewt"><code>mynewt</code></a> branch of <a href="https://github.com/AppKaki/lvgl-wasm/tree/mynewt"><code>github.com/AppKaki/lvgl-wasm</code></a></p>
<p><a href="https://github.com/AppKaki/lvgl-wasm/blob/mynewt/README.md">More about the WebAssembly Simulator</a></p>
<h1 id="advanced-topic-get-the-time" class="section-header"><a href="#advanced-topic-get-the-time">7 Advanced Topic: Get the Time</a></h1>
<p>Check out the previous article to learn how PineTime synchronises its time over Bluetooth LE...</p>
<p><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/timesync">&quot;Bluetooth Time Sync and LVGL on PineTime Mynewt&quot;</a></p>
<p>Here's how we fetch the Mynewt system time in Rust: <a href="https://github.com/lupyuen/pinetime-watchface/blob/master/src/lib.rs#L164-L190"><code>pinetime-watchface/src/lib.rs</code></a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Get the system time</span>
<span class="kw">fn</span> <span class="ident">get_system_time</span>() <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span><span class="ident">WatchFaceTime</span><span class="op">&gt;</span> {
    <span class="comment">//  Get the system time</span>
    <span class="kw">static</span> <span class="kw-2">mut</span> <span class="ident">TV</span>: <span class="ident">os</span>::<span class="ident">os_timeval</span>  <span class="op">=</span> <span class="macro">fill_zero</span><span class="macro">!</span>(<span class="ident">os</span>::<span class="ident">os_timeval</span>);
    <span class="kw">static</span> <span class="kw-2">mut</span> <span class="ident">TZ</span>: <span class="ident">os</span>::<span class="ident">os_timezone</span> <span class="op">=</span> <span class="macro">fill_zero</span><span class="macro">!</span>(<span class="ident">os</span>::<span class="ident">os_timezone</span>);
    <span class="kw">let</span> <span class="ident">rc</span> <span class="op">=</span> <span class="kw">unsafe</span> { <span class="ident">os</span>::<span class="ident">os_gettimeofday</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">TV</span>, <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">TZ</span>) };
    <span class="macro">assert</span><span class="macro">!</span>(<span class="ident">rc</span> <span class="op">==</span> <span class="number">0</span>, <span class="string">&quot;Can&#39;t get time&quot;</span>);    

    <span class="comment">//  Convert the time</span>
    <span class="kw">static</span> <span class="kw-2">mut</span> <span class="ident">CT</span>: <span class="ident">clocktime</span> <span class="op">=</span> <span class="macro">fill_zero</span><span class="macro">!</span>(<span class="ident">clocktime</span>);
    <span class="kw">let</span> <span class="ident">rc</span> <span class="op">=</span> <span class="kw">unsafe</span> { <span class="ident">timeval_to_clocktime</span>(<span class="kw-2">&amp;</span><span class="ident">TV</span>, <span class="kw-2">&amp;</span><span class="ident">TZ</span>, <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">CT</span>) };
    <span class="macro">assert</span><span class="macro">!</span>(<span class="ident">rc</span> <span class="op">==</span> <span class="number">0</span>, <span class="string">&quot;Can&#39;t convert time&quot;</span>);

    <span class="comment">//  Return the time</span>
    <span class="kw">let</span> <span class="ident">result</span> <span class="op">=</span> <span class="kw">unsafe</span> {  <span class="comment">//  Unsafe because CT is a mutable static</span>
        <span class="ident">WatchFaceTime</span> {
            <span class="ident">year</span>:        <span class="ident">CT</span>.<span class="ident">year</span> <span class="kw">as</span> <span class="ident">u16</span>,  <span class="comment">//  Year (4 digit year)</span>
            <span class="ident">month</span>:       <span class="ident">CT</span>.<span class="ident">mon</span>  <span class="kw">as</span>  <span class="ident">u8</span>,  <span class="comment">//  Month (1 - 12)</span>
            <span class="ident">day</span>:         <span class="ident">CT</span>.<span class="ident">day</span>  <span class="kw">as</span>  <span class="ident">u8</span>,  <span class="comment">//  Day (1 - 31)</span>
            <span class="ident">hour</span>:        <span class="ident">CT</span>.<span class="ident">hour</span> <span class="kw">as</span>  <span class="ident">u8</span>,  <span class="comment">//  Hour (0 - 23)</span>
            <span class="ident">minute</span>:      <span class="ident">CT</span>.<span class="ident">min</span>  <span class="kw">as</span>  <span class="ident">u8</span>,  <span class="comment">//  Minute (0 - 59)</span>
            <span class="ident">second</span>:      <span class="ident">CT</span>.<span class="ident">sec</span>  <span class="kw">as</span>  <span class="ident">u8</span>,  <span class="comment">//  Second (0 - 59)</span>
            <span class="ident">day_of_week</span>: <span class="ident">CT</span>.<span class="ident">dow</span>  <span class="kw">as</span>  <span class="ident">u8</span>,  <span class="comment">//  Day of week (0 - 6; 0 = Sunday)</span>
        }
    };
    <span class="prelude-val">Ok</span>(<span class="ident">result</span>)
}</pre></div>
<p>This produces a <a href="https://github.com/lupyuen/pinetime-watchface/blob/master/src/lib.rs#L226-L243"><code>WatchFaceTime</code> struct</a> that's defined in our <a href="https://crates.io/crates/pinetime-watchface"><code>pinetime-watchface</code> Watch Face Framework</a>.</p>
<h1 id="advanced-topic-watch-face-framework" class="section-header"><a href="#advanced-topic-watch-face-framework">8 Advanced Topic: Watch Face Framework</a></h1>
<p>The Watch Face Framework is derived from the Watch Face in C described in this article...</p>
<p><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/timesync#create-watch-face">&quot;Create Watch Face&quot;</a></p>
<p><a href="https://lupyuen.github.io/pinetime-rust-mynewt/articles/timesync#update-watch-face">&quot;Update Watch Face&quot;</a></p>
<p>Here's how the Watch Face Framework starts our Watch Face: <a href="https://github.com/lupyuen/pinetime-watchface/blob/master/src/lib.rs"><code>pinetime-watchface/blob/master/src/lib.rs</code></a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Start rendering the watch face every minute</span>
<span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">start_watch_face</span>(<span class="ident">update_watch_face</span>: <span class="ident">UpdateWatchFace</span>) <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
    <span class="ident">console</span>::<span class="ident">print</span>(<span class="string">&quot;Init Rust watch face...\n&quot;</span>); <span class="ident">console</span>::<span class="ident">flush</span>();

    <span class="comment">//  Save the callback for updating the watch face</span>
    <span class="kw">unsafe</span> { <span class="ident">UPDATE_WATCH_FACE</span> <span class="op">=</span> <span class="prelude-val">Some</span>(<span class="ident">update_watch_face</span>); }

    <span class="comment">//  Get active screen from LVGL</span>
    <span class="kw">let</span> <span class="ident">screen</span> <span class="op">=</span> <span class="ident">get_active_screen</span>();

    <span class="comment">//  Allow touch events</span>
    <span class="ident">obj</span>::<span class="ident">set_click</span>(<span class="ident">screen</span>, <span class="bool-val">true</span>) <span class="question-mark">?</span> ;

    <span class="comment">//  Render the watch face</span>
    <span class="kw">let</span> <span class="ident">rc</span> <span class="op">=</span> <span class="kw">unsafe</span> { <span class="ident">pinetime_lvgl_mynewt_render</span>() };
    <span class="macro">assert</span><span class="macro">!</span>(<span class="ident">rc</span> <span class="op">==</span> <span class="number">0</span>, <span class="string">&quot;LVGL render fail&quot;</span>);    

    <span class="comment">//  Set a timer to update the watch face every minute</span>
    <span class="kw">unsafe</span> {  <span class="comment">//  Unsafe because os_callout_init is a Mynewt C function</span>
        <span class="ident">os</span>::<span class="ident">os_callout_init</span>(
            <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">WATCH_FACE_CALLOUT</span>,         <span class="comment">//  Timer for the watch face</span>
            <span class="ident">os</span>::<span class="ident">eventq_dflt_get</span>().<span class="ident">unwrap</span>(),  <span class="comment">//  Use default event queue</span>
            <span class="prelude-val">Some</span>(<span class="ident">watch_face_callback</span>),       <span class="comment">//  Callback function for the timer</span>
            <span class="ident">ptr</span>::<span class="ident">null_mut</span>()                  <span class="comment">//  No argument</span>
        );    
    }

    <span class="comment">//  Trigger the watch face timer in 60 seconds</span>
    <span class="kw">let</span> <span class="ident">rc</span> <span class="op">=</span> <span class="kw">unsafe</span> {  <span class="comment">//  Unsafe because os_callout_reset is a Mynewt C function</span>
        <span class="ident">os</span>::<span class="ident">os_callout_reset</span>(
            <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">WATCH_FACE_CALLOUT</span>,   <span class="comment">//  Timer for the watch face</span>
            <span class="ident">os</span>::<span class="ident">OS_TICKS_PER_SEC</span> <span class="op">*</span> <span class="number">60</span>  <span class="comment">//  Trigger timer in 60 seconds</span>
        )
    };
    <span class="macro">assert</span><span class="macro">!</span>(<span class="ident">rc</span> <span class="op">==</span> <span class="number">0</span>, <span class="string">&quot;Timer fail&quot;</span>);
    <span class="prelude-val">Ok</span>(())
}

<span class="doccomment">/// Timer that is triggered every minute to update the watch face</span>
<span class="kw">static</span> <span class="kw-2">mut</span> <span class="ident">WATCH_FACE_CALLOUT</span>: <span class="ident">os</span>::<span class="ident">os_callout</span> <span class="op">=</span> <span class="macro">fill_zero</span><span class="macro">!</span>(<span class="ident">os</span>::<span class="ident">os_callout</span>);

<span class="doccomment">/// Called every minute to update the Watch Face</span>
<span class="kw">static</span> <span class="kw-2">mut</span> <span class="ident">UPDATE_WATCH_FACE</span>: <span class="prelude-ty">Option</span><span class="op">&lt;</span><span class="ident">UpdateWatchFace</span><span class="op">&gt;</span> <span class="op">=</span> <span class="prelude-val">None</span>;

<span class="doccomment">/// Type of callback to update the Watch Face</span>
<span class="kw">type</span> <span class="ident">UpdateWatchFace</span> <span class="op">=</span> <span class="kw">fn</span> (<span class="ident">state</span>: <span class="kw-2">&amp;</span><span class="ident">WatchFaceState</span>) <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span>;</pre></div>
<p><code>start_watch_face</code> is called by the <code>main</code> function when PineTime starts up, as we shall see in a while.</p>
<p><code>start_watch_face</code> calls these functions...</p>
<ol>
<li>
<p><code>pinetime_lvgl_mynewt_render</code> comes from the LVGL Mynewt Library and renders the LVGL display</p>
</li>
<li>
<p><code>os::os_callout_init</code> and <code>os::os_callout_reset</code> are Mynewt Functions for creating and setting the Callout Timer <code>WATCH_FACE_CALLOUT</code></p>
</li>
</ol>
<p>Every minute, the Callout Timer <code>WATCH_FACE_CALLOUT</code> triggers this Callback Function to update the Watch Face...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Timer callback that is called every minute</span>
<span class="kw">extern</span> <span class="kw">fn</span> <span class="ident">watch_face_callback</span>(<span class="ident">_ev</span>: <span class="kw-2">*</span><span class="kw-2">mut</span> <span class="ident">os</span>::<span class="ident">os_event</span>) {
    <span class="ident">console</span>::<span class="ident">print</span>(<span class="string">&quot;Update Rust watch face...\n&quot;</span>); <span class="ident">console</span>::<span class="ident">flush</span>();
    
    <span class="comment">//  If there is no callback, fail.</span>
    <span class="macro">assert</span><span class="macro">!</span>(<span class="kw">unsafe</span> { <span class="ident">UPDATE_WATCH_FACE</span>.<span class="ident">is_some</span>() }, <span class="string">&quot;Update watch face missing&quot;</span>);

    <span class="comment">//  Get the system time    </span>
    <span class="kw">let</span> <span class="ident">time</span> <span class="op">=</span> <span class="ident">get_system_time</span>()
        .<span class="ident">expect</span>(<span class="string">&quot;Can&#39;t get system time&quot;</span>);

    <span class="comment">//  Compose the watch face state</span>
    <span class="kw">let</span> <span class="ident">state</span> <span class="op">=</span> <span class="ident">WatchFaceState</span> {
        <span class="ident">time</span>,
        <span class="ident">millivolts</span>: <span class="number">0</span>,     <span class="comment">//  TODO: Get current voltage</span>
        <span class="ident">charging</span>:   <span class="bool-val">true</span>,  <span class="comment">//  TODO: Get charging status</span>
        <span class="ident">powered</span>:    <span class="bool-val">true</span>,  <span class="comment">//  TODO: Get powered status</span>
        <span class="ident">bluetooth</span>:  <span class="ident">BluetoothState</span>::<span class="ident">BLUETOOTH_STATE_CONNECTED</span>,  <span class="comment">//  TODO: Get BLE state</span>
    };

    <span class="comment">//  Update the watch face</span>
    <span class="kw">unsafe</span> {  <span class="comment">//  Unsafe because WATCH_FACE is a mutable static</span>
        <span class="ident">UPDATE_WATCH_FACE</span>.<span class="ident">unwrap</span>()(<span class="kw-2">&amp;</span><span class="ident">state</span>)
            .<span class="ident">expect</span>(<span class="string">&quot;Update Watch Face fail&quot;</span>);
    }

    <span class="comment">//  Render the watch face</span>
    <span class="kw">let</span> <span class="ident">rc</span> <span class="op">=</span> <span class="kw">unsafe</span> { <span class="ident">pinetime_lvgl_mynewt_render</span>() };
    <span class="macro">assert</span><span class="macro">!</span>(<span class="ident">rc</span> <span class="op">==</span> <span class="number">0</span>, <span class="string">&quot;LVGL render fail&quot;</span>);    

    <span class="comment">//  Trigger the watch face timer in 60 seconds</span>
    <span class="kw">let</span> <span class="ident">rc</span> <span class="op">=</span> <span class="kw">unsafe</span> {  <span class="comment">//  Unsafe because os_callout_reset is a Mynewt C function</span>
        <span class="ident">os</span>::<span class="ident">os_callout_reset</span>(
            <span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">WATCH_FACE_CALLOUT</span>,   <span class="comment">//  Timer for the watch face</span>
            <span class="ident">os</span>::<span class="ident">OS_TICKS_PER_SEC</span> <span class="op">*</span> <span class="number">60</span>  <span class="comment">//  Trigger timer in 60 seconds</span>
        )
    };
    <span class="macro">assert</span><span class="macro">!</span>(<span class="ident">rc</span> <span class="op">==</span> <span class="number">0</span>, <span class="string">&quot;Timer fail&quot;</span>);
}</pre></div>
<p><code>get_system_time</code> fetches the current date and time from Mynewt. We have covered this in the previous section.</p>
<p><code>start_watch_face</code> is called by the <code>main</code> function when PineTime starts up: <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/rust/app/src/lib.rs"><code>pinetime-rust-mynewt/rust/app/src/lib.rs</code></a></p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Declare the Watch Face Type</span>
<span class="kw">type</span> <span class="ident">WatchFaceType</span> <span class="op">=</span> <span class="ident">barebones_watchface</span>::<span class="ident">BarebonesWatchFace</span>;

<span class="doccomment">/// Watch Face for the app</span>
<span class="kw">static</span> <span class="kw-2">mut</span> <span class="ident">WATCH_FACE</span>: <span class="ident">WatchFaceType</span> <span class="op">=</span> <span class="macro">fill_zero</span><span class="macro">!</span>(<span class="ident">WatchFaceType</span>);

<span class="doccomment">///  main() will be called at Mynewt startup. It replaces the C version of the main() function.</span>
<span class="attribute">#[<span class="ident">no_mangle</span>]</span>                 <span class="comment">//  Don&#39;t mangle the name &quot;main&quot;</span>
<span class="kw">extern</span> <span class="string">&quot;C&quot;</span> <span class="kw">fn</span> <span class="ident">main</span>() <span class="op">-&gt;</span> <span class="op">!</span> {  <span class="comment">//  Declare extern &quot;C&quot; because it will be called by Mynewt</span>
    <span class="comment">//  Initialise the Mynewt packages and internal temperature sensor driver. Any startup</span>
    <span class="comment">//  functions defined in pkg.yml of our custom drivers and libraries will be called by </span>
    <span class="comment">//  sysinit().  Here are the startup functions consolidated by Mynewt:</span>
    <span class="comment">//  bin/targets/nrf52_my_sensor/generated/src/nrf52_my_sensor-sysinit-app.c</span>
    <span class="ident">mynewt</span>::<span class="ident">sysinit</span>();  <span class="comment">//  LVGL is also initialised here</span>

    <span class="comment">//  Start Bluetooth LE, including over-the-air firmware upgrade.  TODO: Create a safe wrapper for starting Bluetooth LE.</span>
    <span class="kw">extern</span> { <span class="kw">fn</span> <span class="ident">start_ble</span>() <span class="op">-&gt;</span> <span class="ident">i32</span>; }
    <span class="kw">let</span> <span class="ident">rc</span> <span class="op">=</span> <span class="kw">unsafe</span> { <span class="ident">start_ble</span>() };
    <span class="macro">assert</span><span class="macro">!</span>(<span class="ident">rc</span> <span class="op">==</span> <span class="number">0</span>, <span class="string">&quot;BLE fail&quot;</span>);

    <span class="comment">//  Create the watch face</span>
    <span class="kw">unsafe</span> {  <span class="comment">//  Unsafe because WATCH_FACE is a mutable static  </span>
        <span class="ident">WATCH_FACE</span> <span class="op">=</span> <span class="ident">WatchFaceType</span>::<span class="ident">new</span>()
            .<span class="ident">expect</span>(<span class="string">&quot;Create watch face fail&quot;</span>);
    }

    <span class="comment">//  Start rendering the watch face every minute</span>
    <span class="ident">watchface</span>::<span class="ident">start_watch_face</span>(<span class="ident">update_watch_face</span>)
        .<span class="ident">expect</span>(<span class="string">&quot;Watch Face fail&quot;</span>);</pre></div>
<p>The <code>main</code> function creates the Watch Face (like <code>BarebonesWatchFace</code>) and calls <code>start_watch_face</code>, passing this Callback Function...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="doccomment">/// Called every minute to update the Watch Face</span>
<span class="kw">fn</span> <span class="ident">update_watch_face</span>(<span class="ident">state</span>: <span class="kw-2">&amp;</span><span class="ident">WatchFaceState</span>) <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
    <span class="comment">//  Update the watch face</span>
    <span class="kw">unsafe</span> {  <span class="comment">//  Unsafe because WATCH_FACE is a mutable static</span>
        <span class="ident">WATCH_FACE</span>.<span class="ident">update</span>(<span class="ident">state</span>)
    }
}</pre></div>
<p><code>update_watch_face</code> is called by <code>watch_face_callback</code> every minute to refresh the Watch Face.</p>
<h1 id="advanced-topic-rust-wrapper-for-lvgl" class="section-header"><a href="#advanced-topic-rust-wrapper-for-lvgl">9 Advanced Topic: Rust Wrapper for LVGL</a></h1>
<p>TODO: Bindgen, Safe Wrapper Proc Macro, <a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/rust/lvgl"><code>rust/lvgl</code></a></p>
<p>https://lupyuen.github.io/pinetime-rust-mynewt/articles/timesync#porting-lvgl-to-mynewt</p>
<p>https://github.com/lupyuen/pinetime-lvgl/blob/master/README.md</p>
<p>https://github.com/lupyuen/pinetime-lvgl/blob/master/scripts/gen-bindings.sh</p>
<p>https://github.com/lupyuen/pinetime-lvgl/blob/master/logs/expanded.rs#L13262-L13284</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
        <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">set_text</span>(<span class="ident">label</span>: <span class="kw-2">*</span><span class="kw-2">mut</span> <span class="ident">lv_obj_t</span>, <span class="ident">text</span>: <span class="kw-2">&amp;</span><span class="ident">Strn</span>)
         <span class="op">-&gt;</span> <span class="ident">MynewtResult</span><span class="op">&lt;</span>()<span class="op">&gt;</span> {
            <span class="string">&quot;----------Insert Extern Decl: `extern C { pub fn ... }`----------&quot;</span>;
            <span class="kw">extern</span> <span class="string">&quot;C&quot;</span> {
                <span class="attribute">#[<span class="ident">doc</span> <span class="op">=</span>
                  <span class="string">&quot; Set a new text for a label. Memory will be allocated to store the text by the label.&quot;</span>]</span>
                <span class="attribute">#[<span class="ident">doc</span> <span class="op">=</span> <span class="string">&quot; - __`label`__: pointer to a label object&quot;</span>]</span>
                <span class="attribute">#[<span class="ident">doc</span> <span class="op">=</span>
                  <span class="string">&quot; - __`text`__: &#39;\\0&#39; terminated character string. NULL to refresh with the current text.&quot;</span>]</span>
                <span class="kw">pub</span> <span class="kw">fn</span> <span class="ident">lv_label_set_text</span>(<span class="ident">label</span>: <span class="kw-2">*</span><span class="kw-2">mut</span> <span class="ident">lv_obj_t</span>,
                                         <span class="ident">text</span>: <span class="kw-2">*</span><span class="kw">const</span> ::<span class="ident">cty</span>::<span class="ident">c_char</span>);
            }
            <span class="string">&quot;----------Insert Validation: `Strn::validate_bytestr(name.bytestr)`----------&quot;</span>;
            <span class="ident">text</span>.<span class="ident">validate</span>();
            <span class="kw">unsafe</span> {
                <span class="string">&quot;----------Insert Call: `let result_value = os_task_init(`----------&quot;</span>;
                <span class="ident">lv_label_set_text</span>(<span class="ident">label</span> <span class="kw">as</span> <span class="kw-2">*</span><span class="kw-2">mut</span> <span class="ident">lv_obj_t</span>,
                                  <span class="ident">text</span>.<span class="ident">as_ptr</span>() <span class="kw">as</span> <span class="kw-2">*</span><span class="kw">const</span> ::<span class="ident">cty</span>::<span class="ident">c_char</span>);
                <span class="string">&quot;----------Insert Result: `Ok(Strn::from_cstr(result_value))`----------&quot;</span>;
                <span class="prelude-val">Ok</span>(())
            }
        }</pre></div>

    
</body>
</html>